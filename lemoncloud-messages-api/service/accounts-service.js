"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};module.exports=function(e,r,n){r=r||"ACS";var t=["id","type","parent","name","refid","group","role","nick","stereo","message","description","image"],o=t.reduce(function(e,r){return(r=r||"").startsWith("desc")||e.push(r),e},[]),i=e.U,d=e.LEM;if(!i)throw new Error("$U is required!");if(!d)throw new Error("LEM is required!");var u=e.log,c=e.inf,_=e.err,a=i.NS(r),f=d(e,"_"+r,{ID_TYPE:"LemonAccountsSeq",ID_NEXT:1e4,FIELDS:t,DYNA_TABLE:"Accounts",REDIS_PKEY:"CACS",ES_INDEX:"accounts-v1",ES_TYPE:"accounts",ES_FIELDS:o,NS_NAME:r,ES_MASTER:1,CLONEABLE:!0,PARENT_IMUT:!1});if(!f)throw new Error(a+"$LEM is required!");var s=n||{},p=function(e){throw new Error("NOT_IMPLEMENTED - "+a+":"+JSON.stringify(e))};s.$LEM=f,s.do_prepare=p,s.do_create=p,s.do_clone=p,s.do_update=p,s.do_increment=p,s.do_read=p,s.do_delete=p,s.do_destroy=p,s.do_search=p,s.on_records=p,s.do_notify=f.do_notify,s.do_subscribe=f.do_subscribe,s.do_initialize=p,s.do_terminate=p,s.do_test_self=p;var h=function(e,r,n){return f.do_prepare_chain(e,r,n)},m=function(e){return f.do_finish_chain(e)},E=function(e){var r=((""+e.type).trim()+":"+(""+e.name).trim()).toLowerCase();return"MD5"+i.md5(r)};s.calculate_refid=E;var y=function(e){var r=e._node||{},n=(e._id||r.id,r.refid),t=e.type||r.type||"",o=e.name||r.name||"",i=(t.trim()+":"+o.trim()).toLowerCase(),d=":"==i?"":E({type:t,name:o});if(d&&n!=d){if(c(a,">> refid := ",d," (",i,")"),r.id)return h(r.id,{refid:d},"update").then(f.do_update).then(m).then(function(){return e});e.refid=d}return e};return s.do_prepare=function(e,r){var n=e&&"object"===(void 0===e?"undefined":_typeof(e))?e._id:e;return u(a,"do_prepare()... id=",n),h(e,r,"prepare").then(f.do_prepare).then(m)},s.do_create=function(e,r){var n=e&&"object"===(void 0===e?"undefined":_typeof(e))?e._id:e;return n?(u(a,"do_create()... id=",n),h(e,r,"create").then(function(e){return e.type?e.name?e:Promise.reject(new Error("name is required!")):Promise.reject(new Error("type is required!"))}).then(y).then(f.do_create).then(m)):Promise.reject(new Error("id is required!"))},s.do_search_refid=function(e){var n=e.refid;if(!n)return Promise.reject(new Error("refid is required!"));var t=e.type||"",o=e.name||"";return f.do_search(0,{refid:n}).then(function(e){var r=e.list||[];return 0<r.length?r[0]:Promise.reject(new Error("404 NOT FOUND - "+(t?t+":"+o:"refid:"+n)))})},s.do_create_safe=function(e,r){var n=e&&"object"===(void 0===e?"undefined":_typeof(e))?e._id:e;return n?Promise.reject(new Error("id is invalid")):(u(a,"do_create_safe()... id=",n),h(e,r,"create").then(function(e){return e.type?e.name?e:Promise.reject(new Error("name is required!")):Promise.reject(new Error("type is required!"))}).then(y).then(function(n){if((""+(n.name||"")).startsWith("#"))return f.do_prepare(n).then(function(e){return c(a,"! prepared-id@1 =",e._id),n._id=e._id,n._prepared=1,n});var t=n.refid;return t?f.do_search(0,{refid:t}).catch(function(e){var r=e&&e.message||"";_(a,"ERR! message=",void 0===r?"undefined":_typeof(r),r);var n=e&&e.reason||"";if(_(a,"ERR! reason=",void 0===n?"undefined":_typeof(n),n),"No mapping found for [id] in order to sort on"==n)return{list:[]};throw e}).then(function(e){var r=e.list||[];return r.length<1?f.do_prepare(n).then(function(e){return c(a,"! prepared-id@2 =",e._id),n._id=e._id,n._prepared=1,n}):1!==r.length?(_(a,"TOO MANY RESULT BY REFID:"+t+" = ",r),Promise.reject(new Error("Invalid refid@1:"+t))):(n._id=r[0].id,n)}):Promise.reject(new Error("refid is invalid"))}).then(function(e){return e._id&&!e._prepared?f.do_update(e):f.do_create(e)}).then(function(e){return e.id=e._id,e}).then(m))},s.do_clone=function(e,r){var n=e&&"object"===(void 0===e?"undefined":_typeof(e))?e._id:e;return n?(u(a,"do_clone()... id=",n),h(e,r,"clone").then(f.do_clone).then(y).then(m)):Promise.reject(new Error("id is required!"))},s.do_update=function(e,r){var n=e&&"object"===(void 0===e?"undefined":_typeof(e))?e._id:e;return n?(u(a,"do_update()... id=",n),h(e,r,"update").then(function(e){return e.type?Promise.reject(new Error("type is imutable")):e}).then(f.do_update).then(y).then(m)):Promise.reject(new Error("id is required!"))},s.do_increment=function(e,r){var n=e&&"object"===(void 0===e?"undefined":_typeof(e))?e._id:e;return n?(u(a,"do_increment()... id=",n),h(e,r,"increment").then(function(e){return e.type?e:Promise.reject(new Error("type is imutable"))}).then(f.do_increment).then(m)):Promise.reject(new Error("id is required!"))},s.do_read=function(e,r){return(e&&"object"===(void 0===e?"undefined":_typeof(e))?e._id:e)?h(e,r,"read").then(f.do_read).then(m):Promise.reject(new Error("id is required!"))},s.do_delete=function(e,r){return(e&&"object"===(void 0===e?"undefined":_typeof(e))?e._id:e)?h(e,r,"delete").then(f.do_delete).then(m):Promise.reject(new Error("id is required!"))},s.do_destroy=function(e,r){var n=e&&"object"===(void 0===e?"undefined":_typeof(e))?e._id:e;return n?(u(a,"do_destroy()... id=",n),h(e,r,"destroy").then(f.do_destroy).then(m)):Promise.reject(new Error("id is required!"))},s.do_search=function(e,r){var n=e&&"object"===(void 0===e?"undefined":_typeof(e))?e._id:e;return u(a,"do_search()... id=",void 0===e?"undefined":_typeof(e),n),h(e,r,"search").then(f.do_search).then(m)},s.on_records=function(e){return u(a,"on_records()... records.len=",e&&e.records&&e.records.length||0),f.on_records(e||{})},s.do_initialize=function(e){return u(a+"do_initialize()... params=",i.json(e)),f.do_initialize(e||{})},s.do_terminate=function(e){return u(a+"do_terminate()... params=",i.json(e)),f.do_terminate(e||{})},e(r,s),s};