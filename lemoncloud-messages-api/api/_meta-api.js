"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports=module.exports=function(e,d){if(!e)throw new Error("_$(global instance pool) is required!");if(!d)throw new Error("$LMS is required!");if(!d.$LEM)throw new Error("$LMS is not valid engine!");var r=e._,l=e.U;if(!r)throw new Error("$_ is required!");if(!l)throw new Error("$U is required!");var y=e.log,a=e.inf,m=e.err,v=l.NS("META","yellow");function E(e){return g(404,e)}function h(e){return g(503,e)}function g(e,r){return{statusCode:e,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:JSON.stringify(r)}}var t=function(e,r,t){r.callbackWaitsForEmptyEventLoop=!1;var n=e.queryStringParameters||{},o=e.pathParameters||{},i=decodeURIComponent(o.type||""),d=decodeURIComponent(o.id||""),a=(d||"GET"!==e.httpMethod?e.httpMethod:"LIST")||"",s=decodeURIComponent(o.cmd||""),u=!a&&e.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[a],c=e.body&&("string"==typeof e.body&&(e.body.startsWith("{")||e.body.startsWith("["))?JSON.parse(e.body):e.body)||e.Records&&{records:e.Records}||null;!c&&y(v,"#"+u+":"+s+" ("+a+", "+i+"/"+d+")...."),c&&y(v,"#"+u+":"+s+" ("+a+", "+i+"/"+d+").... body.len=",c?l.json(c).length:-1);var p={_id:d,_param:n,_body:c,_ctx:r},f=Promise.resolve(p),_=function(e,r,t){var n=null;switch(e){case"LIST?":n=P;break;case"GET":n=j,"self-test"===t&&(n=w);break;case"PUT":case"POST":case"DELETE":break;case"EVENT":n=b}return n}(u,0,s);if(!_)return t(null,E({MODE:u}));try{f.then(function(e){var r=e._id,t=e._param,n=e._body,o=e._ctx;return _(r,t,n,o)}).then(function(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))&&(e=l.cleanup(e)),t(null,g(200,e)),!0}).catch(function(e){return m(v,"!!! callback@1 with err",e),0<=(e&&e.message||"").indexOf("404 NOT FOUND")?t(null,E(e.message)):t(null,h(e.message||e)),!1})}catch(e){t(e,h(e.message))}};t.do_list_meta=P,t.do_get_meta=j,t.do_put_meta=function(n,e,r,t){var o=Object.assign({},r||e);if(!o.type)return Promise.reject(new Error("type is required!"));var i=o.type;return delete o.type,d.do_read(n,o).then(function(e){var r=e._node||{},t=e.deleted_at||r.deleted_at||0;return t?Promise.reject(new Error("404 NOT FOUND: Node deleted_at="+t)):r.type&&r.type!=i?Promise.reject(new Error("404 NOT FOUND: Invalid Type="+r.type)):(y(v,"> update =",o),d.do_update(n,o))})},t.do_post_meta=function(e,r,t,n){if(0!==e)return Promise.reject(new Error("invalid id:"+e));var o=Object.assign({},t||r);return o.type?d.do_create_safe(e,o):Promise.reject(new Error("type is required!"))},t.do_delete_meta=function(r,e,t,n){if("number"!=typeof r)return Promise.reject(new Error("invalid id:"+r));var o=Object.assign({},t||e);if(!o.type)return Promise.reject(new Error("type is required!"));var i=o.type;return delete o.type,d.do_read(r,o).then(function(t){var e=t._node||{};return t.deleted_at||e.deleted_at?t:e.type&&e.type!=i?Promise.reject(new Error("404 NOT FOUND: Invalid Type="+e.type)):d.do_delete(r,o).then(function(e){var r=(e._node||e).deleted_at||0;return t.deleted_at=r,t})})},t.do_destroy_meta=function(r,e,t,n){if(a(v,"WARN! do_destroy_meta("+r+")...."),"number"!=typeof r)return Promise.reject(new Error("invalid id:"+r));var o=Object.assign({},t||e);if(!o.type)return Promise.reject(new Error("type is required!"));var i=o.type;return delete o.type,d.do_read(r,o).then(function(t){var e=t._node||{};return t.deleted_at||e.deleted_at?e.type&&e.type!=i?Promise.reject(new Error("404 NOT FOUND: Invalid Type="+e.type)):d.do_destroy(r,o).then(function(e){var r=(e._node||e).deleted_at||0;return t.deleted_at=r,t}):Promise.reject(new Error("404 NOT FOUND: Node is not deleted!"))})},t.do_initialize_meta=n,t.do_terminate_meta=o,t.do_self_test_meta=w,t.do_event_records=b;t.do_chain_on_update_parent=function(r){if(!r.type)return Promise.reject(new Error("type is required!"));var t=r.type;if(void 0!==r.parent){var n=r.parent;if(n&&"0"!==n){if("string"==typeof r.parent){var o={type:t,name:r.parent};return o.refid=d.calculate_refid(o),d.do_search_refid(o).then(function(e){return y(v,"> set parent-id :=",e.id,"<- ref:"+o.refid),r.parent=e.id,r.parent==r.id||r.parent==r._id?Promise.reject(new Error("parent is same as id")):r})}return d.do_read(n).then(function(e){return y(v,"> set parent-id :=",e.id,"<- pid:"+n),r.parent=e.id,e.type!==t?Promise.reject(new Error("parent.type is different. type:"+e.type)):r.parent==r.id||r.parent==r._id?Promise.reject(new Error("parent-id is same as id")):r})}r.parent=0}return r};t.do_chain_on_update_group=function(t){if(void 0!==t.group){var n=t.group;if(n&&"0"!==n&&""!==n){if("string"==typeof t.group){var o={type:"group",name:n};return o.refid=d.calculate_refid(o),d.do_search_refid(o).then(function(e){return y(v,"> set group-id :=",e.id,"<- refid:",o.refid),t.group=e.id,t}).catch(function(e){var r=e&&e.message||"";if(m(v,"ERR! search-refid =",r),r.startsWith("404 NOT FOUND - group:"))return d.do_create_safe(0,o).then(function(e){return y(v,"> set group-id@2 :=",e.id,"<- gid:"+n),t.group=e.id,t});throw e})}return d.do_read(n).then(function(e){return y(v,"> set group-id :=",e.id,"<- gid:"+n),t.group=e.id,"group"!==e.type?Promise.reject(new Error("group.type is different. type:"+e.type)):t.group==t.id||t.group==t._id?Promise.reject(new Error("group-id is same as id")):t})}t.group=0}return t};t.do_chain_on_update_role=function(r){if(void 0!==r.role){var t=r.role;if(t&&"0"!==t&&""!==t){if("string"==typeof r.role){var n={type:"role",name:t};return n.refid=d.calculate_refid(n),d.do_search_refid(n).then(function(e){return y(v,"> set role-id :=",e.id,"<- refid:",n.refid),r.role=e.id,r})}return d.do_read(t).then(function(e){return y(v,"> set role-id :=",e.id,"<- rid:"+t),r.role=e.id,"role"!==e.type?Promise.reject(new Error("role.type is different. type:"+e.type)):r.role==r.id||r.role==r._id?Promise.reject(new Error("role-id is same as id")):r})}r.role=0}return r};function n(e,r,t,n){if(y(v,"do_initialize_meta("+e+")...."),"0"!==e)return Promise.reject(new Error("invalid ID:"+e));var o=Object.assign({},r);return a(v,"WARN! initialize ",d.name),Promise.resolve(o).then(function(e){return d.do_initialize()})}function o(e,r,t,n){if(y(v,"do_terminate_meta("+e+")...."),"0"!==e)return Promise.reject(new Error("invalid ID:"+e));var o=Object.assign({},r);return a(v,"WARN! terminate ",d.name),Promise.resolve(o).then(function(e){return d.do_terminate()})}function w(e,r,t,n){y(v,"do_self_test_meta("+e+")....");var o=Object.assign({},t||{});return o.id=l.N(e,0),Promise.resolve(o).then(function(e){return d.do_test_self(e,r)})}function P(e,r,t,n){var o=Object.assign({},t||r);return o.type?d.do_search(e,o):Promise.reject(new Error("type is required!"))}function j(e,r,t,n){var o=Object.assign({},t||r);if(!o.type)return Promise.reject(new Error("type is required!"));var i=o.type;return delete o.type,d.do_read(e,o).then(function(e){var r=e._node||{},t=e.deleted_at||r.deleted_at||0;return t?Promise.reject(new Error("404 NOT FOUND: Node deleted_at="+t)):r.type&&r.type!=i?Promise.reject(new Error("404 NOT FOUND: Invalid Type="+r.type)):e})}function b(e,r,t,n){return y(v,"do_event_records("+e+")...."),d.on_records(t)}return t};