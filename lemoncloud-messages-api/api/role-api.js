"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports=module.exports=function(e,t){if(!e)throw new Error("_$(global instance pool) is required!");var r=e._,p=e.U;if(!r)throw new Error("$_ is required!");if(!p)throw new Error("$U is required!");var f=e.log,h=(e.inf,e.err),y=p.NS("ROLE","yellow");function b(e){return v(404,e)}function E(e){return v(503,e)}function v(e,t){return{statusCode:e,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:JSON.stringify(t)}}var o=function(e,t,r){t.callbackWaitsForEmptyEventLoop=!1;var o=e.queryStringParameters||{},n=e.pathParameters||{},i=decodeURIComponent(n.type||""),a=decodeURIComponent(n.id||""),s=(a||"GET"!==e.httpMethod?e.httpMethod:"LIST")||"",d=decodeURIComponent(n.cmd||""),u=!s&&e.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[s],c=e.body&&("string"==typeof e.body&&(e.body.startsWith("{")||e.body.startsWith("["))?JSON.parse(e.body):e.body)||e.Records&&{records:e.Records}||null;!c&&f(y,"#"+u+":"+d+" ("+s+", "+i+"/"+a+")...."),c&&f(y,"#"+u+":"+d+" ("+s+", "+i+"/"+a+").... body.len=",c?p.json(c).length:-1);var l={_id:a,_param:o,_body:c,_ctx:t},_=Promise.resolve(l),m=function(e,t,r){var o=null;switch(e){case"LIST":o=g;break;case"GET":o=T,"0"===t&&"self-test"===r&&(o=do_self_test_role);break;case"PUT":o=S;break;case"POST":o=P;break;case"DELETE":o=w}return o}(u,a,d);if(!m)return r(null,b({MODE:u}));try{_.then(function(e){var t=e._id,r=e._param,o=e._body,n=e._ctx;return m(t,r,o,n)}).then(function(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))&&(e=p.cleanup(e)),r(null,v(200,e)),!0}).catch(function(e){return h(y,"!!! callback@1 with err",e),0<=(e&&e.message||"").indexOf("404 NOT FOUND")?r(null,b(e.message)):r(null,E(e.message||e)),!1})}catch(e){r(e,E(e.message))}};o.do_list_role=g,o.do_get_role=T,o.do_put_role=S,o.do_post_role=P,o.do_delete_role=w;var n="role",i={id:"ID",parent:"Parent ID (상위 조직의 ID)",group:"Group ID (???)",role:"Role ID (???)",name:"Name (그룹 고유 이름ID)",nick:"Show Name (표시할 이름)",message:"Short Description (그룹의 상태 표시 메세지)",description:"Long Description (그룹의 상세 내용)",image:"Image URL (대표 이미지)",state:"State (그룹 상태)",source:"Creator ID (생성자)",created_at:"Created Time",updated_at:"Updated Time",deleted_at:"Deleted Time"},a=require("./_meta-api")(e,e.ACS),s=function(o){o=o||{};var e=Object.keys(i).reduce(function(e,t,r){return void 0!==o[t]&&(e[t]=o[t]),e},{});return void 0!==o._id&&(e._id=o._id),e},d=function(e){return e.type=n,e},u=function(e){return void 0!==e.name&&(e.name=(""+e.name).trim()),a.do_chain_on_update_parent(e)},c=function(e){return a.do_chain_on_update_role(e)};function g(e,t,r,o){return f(y,"do_list_role("+e+")...."),(t=t||{}).type=n,a.do_list_meta(e,t).then(function(e){var t=e.list||[];return e.list=t.map(s),e})}function T(e,t,r,o){return f(y,"do_get_role("+e+")...."),(t=t||{}).type=n,a.do_get_meta(e,t).then(s)}function S(t,e,r,o){f(y,"do_put_role("+t+")...."),e=e||{};var n=Object.assign({},r||{});return n?(n._id=p.N(t,0),Promise.resolve(n).then(s).then(d).then(u).then(c).then(function(e){return a.do_put_meta(t,e)})):Promise.reject(new Error("node is required!"))}function P(t,e,r,o){if(f(y,"do_post_role("+t+")...."),"0"!==t&&0!==t)return Promise.reject(new Error("invalid ID:"+t));e=e||{};var n=Object.assign({},r||{});return n?(t=p.N(t,0),Promise.resolve(n).then(s).then(d).then(u).then(c).then(function(e){return a.do_post_meta(t,e)}).then(s)):Promise.reject(new Error("node is required!"))}function w(t,e,r,o){f(y,"do_delete_role("+t+")....");var n=void 0!==(e=e||{}).destroy,i=Object.assign({},r||{});return i?(t=p.N(t,0),Promise.resolve(i).then(s).then(d).then(function(e){return n?a.do_destroy_meta(t,e):a.do_delete_meta(t,e)})):Promise.reject(new Error("node is required!"))}return o};