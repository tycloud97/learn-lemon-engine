"use strict";var _slicedToArray=function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var t=[],n=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(n=(a=u.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw i}}return t}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports=module.exports=function(e,r){if(!e)throw new Error("_$(global instance pool) is required!");var t=e._,_=e.U;if(!t)throw new Error("$_ is required!");if(!_)throw new Error("$U is required!");var f=e.log,h=(e.inf,e.err),y=_.NS("USER","yellow"),a=e.ACS;if(!a)throw new Error("$ACS is required!");function g(e){return b(404,e)}function v(e){return b(503,e)}function b(e,r){return{statusCode:e,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:JSON.stringify(r)}}var n=function(e,r,t){r.callbackWaitsForEmptyEventLoop=!1;var n=e.queryStringParameters||{},o=e.pathParameters||{},i=decodeURIComponent(o.type||""),a=decodeURIComponent(o.id||""),u=(a||"GET"!==e.httpMethod?e.httpMethod:"LIST")||"",s=decodeURIComponent(o.cmd||""),d=!u&&e.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[u],c=e.body&&("string"==typeof e.body&&(e.body.startsWith("{")||e.body.startsWith("["))?JSON.parse(e.body):e.body)||e.Records&&{records:e.Records}||null;!c&&f(y,"#"+d+":"+s+" ("+u+", "+i+"/"+a+")...."),c&&f(y,"#"+d+":"+s+" ("+u+", "+i+"/"+a+").... body.len=",c?_.json(c).length:-1);var l={_id:a,_param:n,_body:c,_ctx:r},m=Promise.resolve(l),p=function(e,r,t){var n=null;switch(e){case"LIST":n=E;break;case"GET":n=w;break;case"PUT":n=T;break;case"POST":n=S;break;case"DELETE":n=k;break;case"EVENT":n=P}return n}(d);if(!p)return t(null,g({MODE:d}));try{m.then(function(e){var r=e._id,t=e._param,n=e._body,o=e._ctx;return p(r,t,n,o)}).then(function(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))&&(e=_.cleanup(e)),t(null,b(200,e)),!0}).catch(function(e){return h(y,"!!! callback@1 with err",e),0<=(e&&e.message||"").indexOf("404 NOT FOUND")?t(null,g(e.message)):t(null,v(e.message||e)),!1})}catch(e){t(e,v(e.message))}};n.do_list_user=E,n.do_get_user=w,n.do_put_user=T,n.do_post_user=S,n.do_delete_user=k;var u="user",o={id:"ID",parent:"Parent User ID (같은 유저끼리 묶을 때, 상위 유저 속성)",group:"Group/Org ID (유저가 속한 조직/채널)",role:"Role ID (???)",name:"UserName/Email/HP (유저 고유 식별번호)",nick:"Display Name (표시이름)",message:"Short Description (유저 상태 메세지)",description:"Long Description (유저 상세 정보)",image:"Image/Avatar URL (유저 이미지/아바타)",state:"State (상태)",source:"Creator ID (작성자)",created_at:"Created Time",updated_at:"Updated Time",deleted_at:"Deleted Time"},s=require("./_meta-api")(e,e.ACS),d=require("./group-api")(e),c=function(n){n=n||{};var e=Object.keys(o).reduce(function(e,r,t){return void 0!==n[r]&&(e[r]=n[r]),e},{});return void 0!==n._id&&(e._id=n._id),e},l=function(e){return e.type=u,e},i=function(e){if(!e.name||"string"!=typeof e.name)return Promise.reject(new Error("name is invalid. name:"+e.name));var r=e.name.trim(),t=e.group;return!t&&0<r.indexOf("@")&&(t=r.split("@",2)[1]),t?(e.name=r,e.group=t,e):Promise.reject(new Error("group is required."))},m=function(e){return void 0!==e.name&&(e.name=(""+e.name).trim()),s.do_chain_on_update_parent(e)},p=function(e){return s.do_chain_on_update_group(e)};function E(e,r,t,n){return f(y,"do_list_user("+e+")...."),(r=r||{}).type=u,s.do_list_meta(e,r).then(function(e){var r=e.list||[];return e.list=r.map(c),e})}function w(e,r,t,n){f(y,"do_get_user("+e+")...."),(r=r||{}).type=u;var o=(""+(e||"")).toLowerCase();if(o&&/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(o)){f(y,"! email=",o);var i={type:u,name:o};return i.refid=a.calculate_refid(i),a.do_search_refid(i).then(function(e){return f(y,"> set email-id :=",e.id,"<- ref:"+i.refid),e.id}).catch(function(e){if(h(y,"! err=",e),(e&&e.message||"").startsWith("404 NOT FOUND")){if(i.name){var r=i.name.split("@",2),t=_slicedToArray(r,2),n=t[0],o=t[1];i.nick=n||"nobody",i.group=o||"nowhere",i.nick="d.kim"===i.nick?"daniel":i.nick,i.nick="kai.w"===i.nick?"kai":i.nick,i.nick=i.nick.charAt(0).toUpperCase()+i.nick.slice(1),i.image="/assets/avatars/"+i.nick.toLowerCase()+("Steve"===i.nick?".png":".jpg")}return f(y,">> new-node :=",i),Promise.resolve(i).then(function(r){return r.group?d.do_post_group(0,{name:r.group}).then(function(e){return f(y,">> group-id :=",e.id),r.group=e.id,r}):(r.group=0,r)}).then(function(e){return s.do_post_meta(0,e).then(function(e){return e.id})})}throw e}).then(function(e){return s.do_get_meta(e,r).then(c)})}return s.do_get_meta(e,r).then(c)}function T(r,e,t,n){f(y,"do_put_user("+r+")....");var o=Object.assign({},t||{});return o?(o._id=_.N(r,0),Promise.resolve(o).then(c).then(l).then(m).then(p).then(function(e){return s.do_put_meta(r,e)})):Promise.reject(new Error("node is required!"))}function S(r,e,t,n){if(f(y,"do_post_user("+r+")...."),"0"!==r&&0!==r)return Promise.reject(new Error("invalid ID:"+r));e=e||{};var o=Object.assign({},t||{});return o?(r=_.N(r,0),Promise.resolve(o).then(c).then(i).then(l).then(m).then(p).then(function(e){return s.do_post_meta(r,e)}).then(c)):Promise.reject(new Error("node is required!"))}function k(r,e,t,n){f(y,"do_delete_user("+r+")....");var o=void 0!==(e=e||{}).destroy,i=Object.assign({},t||{});return i?(r=_.N(r,0),Promise.resolve(i).then(c).then(l).then(function(e){return o?s.do_destroy_meta(r,e):s.do_delete_meta(r,e)})):Promise.reject(new Error("node is required!"))}function P(e,r,t,n){return s.do_event_records(e,r,t,n)}return n};