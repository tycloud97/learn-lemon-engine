"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports=module.exports=function(o,e){if(!o)throw new Error("_$(global instance pool) is required!");var r=o._,p=o.U;if(!r)throw new Error("$_ is required!");if(!p)throw new Error("$U is required!");var y=o.log,_=(o.inf,o.err),h=p.NS("INQR","yellow"),t=o.MMS;if(!t)throw new Error("$MMS is required!");var i=function(){if(!o.user)throw new Error("$user is required!");return o.user},s=function(){if(!o.chat)throw new Error("$chat is required!");return o.chat};function b(e){return g(404,e)}function v(e){return g(503,e)}function g(e,r){return{statusCode:e,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:JSON.stringify(r)}}var n=function(e,r,t){r.callbackWaitsForEmptyEventLoop=!1;var o=e.queryStringParameters||{},n=e.pathParameters||{},i=decodeURIComponent(n.type||""),s=decodeURIComponent(n.id||""),a=(s||"GET"!==e.httpMethod?e.httpMethod:"LIST")||"",u=decodeURIComponent(n.cmd||""),c=!a&&e.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[a],d=e.body&&("string"==typeof e.body&&(e.body.startsWith("{")||e.body.startsWith("["))?JSON.parse(e.body):e.body)||e.Records&&{records:e.Records}||null;!d&&y(h,"#"+c+":"+u+" ("+a+", "+i+"/"+s+")...."),d&&y(h,"#"+c+":"+u+" ("+a+", "+i+"/"+s+").... body.len=",d?p.json(d).length:-1);var l={_id:s,_param:o,_body:d,_ctx:r},m=Promise.resolve(l),f=function(e,r,t){var o=null;switch(e){case"LIST":case"GET":case"PUT":break;case"POST":o=E}return o}(c);if(!f)return t(null,b({MODE:c}));try{m.then(function(e){var r=e._id,t=e._param,o=e._body,n=e._ctx;return f(r,t,o,n)}).then(function(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))&&(e=p.cleanup(e)),t(null,g(200,e)),!0}).catch(function(e){return _(h,"!!! callback@1 with err",e),0<=(e&&e.message||"").indexOf("404 NOT FOUND")?t(null,b(e.message)):t(null,v(e.message||e)),!1})}catch(e){t(e,v(e.message))}};n.do_post_inquiry=E;var a={id:"ID",name:'Tag (should be "#inquiry")',nick:"Sender Nickname",message:"Subject (문의 제목)",description:"Long Message body (문의 내용)",source:"Creator (as email)",target:"Target? (as email)",created_at:"Created Time",updated_at:"Updated Time"},u=function(o){o=o||{};var e=Object.keys(a).reduce(function(e,r,t){return void 0!==o[r]&&(e[r]=o[r]),e},{});return void 0!==o._id&&(e._id=o._id),e};function E(e,r,t,o){if(y(h,"do_post_inquiry("+e+")...."),"string"==typeof e&&e.startsWith("#"))return y(h,"POST:"+e,", body=",t),Promise.resolve({text:"ok"});if("0"!==e&&0!==e)return Promise.reject(new Error("invalid ID:"+e));var n=Object.assign(r||{},t||{});if(!n)return Promise.reject(new Error("node is required!"));e=p.N(e,0);var i=function(e){return e.replace(/[&<>]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;"}[e]||e})};return Promise.resolve(n).then(u).then(function(e){(e.source||"").trim();if(!e.source)return Promise.reject(new Error("source is required!"));(e.message||"").trim();if(!e.message)return Promise.reject(new Error("message is required!"));e.message=i(e.message);var r=(e.description||"").trim();return e.description=i(r),e.name="#inquiry",e}).then(function(e){return s().do_post_chat(0,null,e)})}function c(r){if(!r._email)return r;var e=o.WS;if(!e)return Promise.reject(new Error("$WS is required!"));var t={attachments:[{pretext:"New "+(r.name||"message")+" from "+r.nick+" ("+r._email+")",color:"#FFB71B",title:r.message,title_link:"mailto:"+r._email,text:r.description||"",ts:r._current_time/1e3}]};return e.do_post("https://hooks.slack.com","/services/T8247RS6A/BA14X5RAB/2zxCj5IwMitbEaYWy3S3aORG",void 0,void 0,t).catch(function(e){return _(h,"!ERR=",e),r}).then(function(e){return y(h,"> ret=",e),r})}function d(e){e.id||e._id;var r,t=(e.data||{})._node||{},o=t.id||"",n=(t.type,e.data&&e.data._diff||[]);return o?0<=n.indexOf("created_at")&&t.source&&"chat"===t.type?(r=t,void 0!==r.source?i().do_get_user(r.source).then(function(e){return r._email=e.name,r}):r).then(c).then(function(){return e}):Promise.resolve(e):Promise.reject("ID is required!")}return t.do_subscribe(":record:update",d),t.do_subscribe(":record:event",d),n};