"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r};module.exports=function(r,e,t){e=e||"NS";var f=r.U,o=r._;if(!f)throw new Error("$U is required!");if(!o)throw new Error("$_ is required!");var d=f.NS(e,"magenta"),c=t||{},i=function(r){throw new Error("NOT_IMPLEMENTED - "+d+":"+JSON.stringify(r))};c.do_notify=i,c.do_subscribe=i,e.startsWith("!")||e.startsWith("_")||r(e,c);var n=function(r,e){return void 0===c[r]?e:c[r]},a=n("NS_NAME",""),s=n("MASTER",null),l=n("CHILDS",[]),_=["create","update","delete"];c.$notify={};var u=function(t){if(!a)return Promise.resolve(t);if(!t._id)return Promise.reject(new Error(d+"notify:_id is required!"));var r=""+t._id;if(_log(d,"- my_notify_trigger("+r+")...."),!r.startsWith(a+":"))return _log(d,"! WARN - ignored due to id="+r+" by NS="+a),t;var e=c.$notify[r];return e?Promise.all(e.map(function(r,e){try{return r.handle?r.handle(t):r.promise?r.promise:null}catch(r){return _err(d,">> action["+e+"] :",r),r}})).then(function(){return _log(d,"! finished call subscriptions!!! count="+e.length),t}).catch(function(r){throw _err(d,"actions.error=",r),r}):(_log(d,"! WARN - ignored due to no subscription. id="+r),t)};if(s){var y=":record:*";_log(d,">>>>> subscribe master ("+y+") ... "),s.do_subscribe(":record:*",function(r){_log(d,"- on-notified-record ("+r._id+").... that=",f.json(r));var e=r._id||"",t=e.split(":");if(t.length<2)return r;t.shift(),t.unshift(a);var o=t.join(":"),i=f.extend({},r);return i._id=o,i._id_org=e,u(i)}).then(function(r){_log(d,"! subscribed master. res=",r)}),_log(d,"<<<<< subscribe master ("+y+") ... ")}var b=function(r){return r};return c.do_notify=function(r,e){return function(r,e,t){r=r||"",t=t||"",a&&_log(d,"do_"+t+"()... id=",r&&r._id||r&&r.records&&"record#:"+r.records.length||r);var o=e="object"===(void 0===r?"undefined":_typeof(r))?r:{_id:r,_current_mode:t,data:e};return f.promise(o)}(r,e,"notify").then(u).then(b)},c.do_subscribe=function(r,e){var t=e="object"===(void 0===r?"undefined":_typeof(r))?r:f.extend(void 0!==e&&("object"!==(void 0===e?"undefined":_typeof(e))||e instanceof Promise)?{params:e}:e||{},{_id:r});if(!a)return Promise.resolve(t);if(!t._id)return Promise.reject(new Error(d+"notify:_id is required!"));if(!t.params)return Promise.reject(new Error(d+"notify:params is required!"));var o=""+t._id,i=t.params;if(_log(d,"- my_notify_subscribe_sync("+o+").... params=",void 0===i?"undefined":_typeof(i)),o.startsWith(":")&&(o=a+o,t._id=o),!o.startsWith(a+":")){if(!l||!l.length)return _log(d,"! ignored subscribe due to NS-NAME:"+a),Promise.resolve(t);_log(d,"> bubble down for target notifier!!! id=",o);var n=l.map(function(r){return r.do_subscribe(t)});return Promise.all(n).then(function(){return t})}_log(d,"> INFO! - register subscriber by id ="+o);var s={handle:null,promise:null};if("function"==typeof i)s.callee=i,s.handle=function(t){var o=this.callee;return new Promise(function(r,e){try{r(o(t))}catch(r){e(r)}})};else{if(!("object"===(void 0===i?"undefined":_typeof(i))&&i instanceof Promise))return Promise.reject(new Error(d+"invalid params type:"+(void 0===i?"undefined":_typeof(i))));s.promise=i}if(s)if(o.endsWith(":*")){var u=o.substring(0,o.length-1);_.forEach(function(r){var e=u+r;c.$notify[e]||(c.$notify[e]=[]),c.$notify[e].push(s),_log(d,"> notify-subscribe("+e+") count=",c.$notify[e].length)}),_log(d,"! notify-subscribe("+o+") ... modes=",_.join("/"))}else c.$notify[o]||(c.$notify[o]=[]),c.$notify[o].push(s),_log(d,"! notify-subscribe("+o+") count=",c.$notify[o].length);return _log(d,"! subscribed-notify("+o+")... that=",f.json(t)),Promise.resolve(t)},c};