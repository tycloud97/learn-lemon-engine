"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports=module.exports=function(e,r){if(!e)throw new Error("_$(global instance pool) is required!");var t=e._,y=e.U;if(!t)throw new Error("$_ is required!");var p=y.NS(r||"CRNS","yellow"),b=e.log,m=(e.inf,e.err),l=function(){if(!e.CR)throw new Error("$CR(cron-service) is required!");return e.CR};function E(e){return T(404,e)}function h(e){return T(503,e)}function T(e,r){return{statusCode:e,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:JSON.stringify(r)}}function g(e,r,t,o,n){b(p,"do_list_rules("+e+"/"+r+")....");var s=y.N(t.list,10),i=t.prefix||"",u=t.token||"";return l().do_list_rules(s,i,u)}function S(e,r,t,o,n){return b(p,"do_get_rule("+e+"/"+r+")...."),r?l().do_describe_rule(r):Promise.reject(new Error("ID is required!"))}function w(e,r,t,o,n){return b(p,"do_get_rule("+e+"/"+r+")...."),r?l().do_enable_rule(r,!0):Promise.reject(new Error("ID is required!"))}function v(e,r,t,o,n){return b(p,"do_get_rule("+e+"/"+r+")...."),r?l().do_enable_rule(r,!1):Promise.reject(new Error("ID is required!"))}function P(e,r,t,o,n){if(b(p,"do_list_targets("+e+"/"+r+")...."),!r)return Promise.reject(new Error("ID is required!"));var s=y.N(t.list,10),i=t.token||"";return l().do_list_targets(r,s,i)}function I(e,r,t,o,n){return b(p,"do_post_save_rule("+e+"/"+r+")...."),r?l().do_save_rule(r,o):Promise.reject(new Error("ID is required!"))}return function(e,r,t){r.callbackWaitsForEmptyEventLoop=!1;var o=e.queryStringParameters||{},n=e.pathParameters||{},s=decodeURIComponent(n.type||""),i=decodeURIComponent(n.id||""),u=(i||"GET"!==e.httpMethod?e.httpMethod:"LIST")||"",l=decodeURIComponent(n.cmd||""),c=!u&&e.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[u],d=e.body&&("string"==typeof e.body&&(e.body.startsWith("{")||e.body.startsWith("["))?JSON.parse(e.body):e.body)||e.Records&&{records:e.Records}||null;!d&&b(p,"#"+c+":"+l+" ("+u+", "+s+"/"+i+")...."),d&&b(p,"#"+c+":"+l+" ("+u+", "+s+"/"+i+").... body.len=",d?y.json(d).length:-1);var a={_id:i,_type:s,_param:o,_body:d,_ctx:r},_=Promise.resolve(a),f=function(e,r,t,o){var n=null;switch(e){case"LIST":"rules"===r&&""===t&&""===o&&(n=g);break;case"GET":"rules"===r&&""!==t&&""===o?n=S:"rules"===r&&""!==t&&"enable"===o?n=w:"rules"===r&&""!==t&&"disable"===o?n=v:"rules"===r&&""!==t&&"targets"===o&&(n=P);break;case"PUT":break;case"POST":"rules"===r&&""!==t&&""===o&&(n=I)}return n}(c,s,i,l);if(!f)return t(null,E({MODE:c}));try{_.then(function(e){var r=e._id,t=e._type,o=e._param,n=e._body,s=e._ctx;return f(t,r,o,n,s)}).then(function(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))&&(e=y.cleanup(e)),t(null,T(200,e)),!0}).catch(function(e){return m(p,"!!! callback@1 with err",e),0<=(e&&e.message||"").indexOf("404 NOT FOUND")?t(null,E(e.message)):t(null,h(e.message||e)),!1})}catch(e){t(e,h(e.message))}}};