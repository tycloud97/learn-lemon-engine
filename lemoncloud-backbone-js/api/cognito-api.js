"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r};exports=module.exports=function(r,e){if(!r)throw new Error("_$(global instance pool) is required!");var t=r._,_=r.U,l=r.CS;if(!t)throw new Error("$_ is required!");if(!_)throw new Error("$U is required!");if(!l)throw new Error("$CS is required!");var E=_.NS(e||"COGS","yellow"),P=r.log,g=(r.inf,r.err);function w(r){return j(404,r)}function b(r){return j(503,r)}function j(r,e){return{statusCode:r,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:JSON.stringify(e)}}function p(t,i,r,e,n){if(P(E,"do_list_user("+t+"/"+i+")...."),!t)return Promise.reject(new Error("TYPE is required!"));var o=Object.assign({},r||{});if(!o)return Promise.reject(new Error("node is required!"));var s=_.N(o.limit,1),u=o.email,c=o.name,d=o.username,a=void 0!==u?"email":void 0!==c?"name":void 0!==d?"username":"",f=r[a]||"";return l.do_list_user(t,a,f,s).then(function(r){var e=r.list||[];return P(E,"> list-user["+t+"/"+i+"].len :=",e.length),o.result=r,o})}function q(e,t,r,i,n){if(P(E,"do_get_user("+e+"/"+t+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if(!t)return Promise.reject(new Error("ID is required!"));var o=Object.assign({},r||{});return o?l.do_get_user(e,t).then(function(r){return P(E,"> get-user["+e+"/"+t+"] :=",r),o.result=r,o}):Promise.reject(new Error("node is required!"))}function h(e,t,r,i,n){if(P(E,"do_get_enable_user("+e+"/"+t+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if(!t)return Promise.reject(new Error("ID is required!"));var o=Object.assign({},r||{});return o?l.do_get_enable_user(e,t).then(function(r){return P(E,"> enable-user["+e+"/"+t+"] :=",r),o.result=r,o}):Promise.reject(new Error("node is required!"))}function y(e,t,r,i,n){if(P(E,"do_get_disable_user("+e+"/"+t+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if(!t)return Promise.reject(new Error("ID is required!"));var o=Object.assign({},r||{});return o?l.do_get_disable_user(e,t).then(function(r){return P(E,"> disable-user["+e+"/"+t+"] :=",r),o.result=r,o}):Promise.reject(new Error("node is required!"))}function v(e,t,r,i,n){if(P(E,"do_get_confirm_user("+e+"/"+t+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if(!t)return Promise.reject(new Error("ID is required!"));var o=Object.assign({},r||{});return o?l.do_get_confirm_user(e,t).then(function(r){return P(E,"> confirm-user["+e+"/"+t+"] :=",r),o.result=r,o}):Promise.reject(new Error("node is required!"))}function T(e,t,r,i,n){if(P(E,"do_update_user("+e+"/"+t+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if(!t)return Promise.reject(new Error("ID is required!"));var o=Object.assign({},i||{});return o?l.do_update_user(e,t,o).then(function(r){return P(E,"> update-user["+e+"/"+t+"] :=",r),o.result=r,o}):Promise.reject(new Error("node is required!"))}function O(e,t,r,i,n){if(P(E,"do_list_group("+e+"/"+t+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if("!"!==t)return Promise.reject(new Error("ID is required!"));var o=Object.assign({},r||{});if(!o)return Promise.reject(new Error("node is required!"));var s=_.N(o.limit,1);return l.do_list_group(e,s).then(function(r){P(E,"> list-group["+e+"/"+t+"] :=",r);r.list;return o.result=r,o})}function S(e,t,r,i,n){if(P(E,"do_get_group("+e+"/"+t+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if(!t.startsWith("!"))return Promise.reject(new Error("ID is required!"));if(!(t=t.substring(1)))return Promise.reject(new Error("ID is required!"));var o=Object.assign({},r||{});return o?l.do_get_group(e,t).then(function(r){return P(E,"> get-group["+e+"/"+t+"] :=",r),o.result=r,o}):Promise.reject(new Error("node is required!"))}function I(e,t,r,i,n){if(P(E,"do_create_group("+e+"/"+t+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if(!t.startsWith("!"))return Promise.reject(new Error("ID is required!"));t="0"==(t=t.substring(1))?"":t;var o=Object.assign({},i||{});if(!o)return Promise.reject(new Error("node is required!"));var s=(t||o.name||"").trim();if(!s)return Promise.reject(new Error("name is required!"));var u=(o.description||"").trim();return l.do_create_group(e,s,u).then(function(r){return P(E,"> create-group["+e+"/"+t+"] :=",r),o.result=r,o})}function D(e,t,r,i,n){if(P(E,"do_post_user_group("+e+"/"+t+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if(!t.startsWith("!"))return Promise.reject(new Error("ID is required!"));if(!(t=t.substring(1)))return Promise.reject(new Error("ID is required!"));var o=Object.assign({},i||{});if(!o)return Promise.reject(new Error("node is required!"));var s=(o.user||"").trim();return s?l.do_add_user_to_group(e,t,s).then(function(r){return P(E,"> add-user-group["+e+"/"+t+"] :=",r),o.result=r,o}):Promise.reject(new Error("user is required!"))}return function(r,e,t){e.callbackWaitsForEmptyEventLoop=!1;var i=r.queryStringParameters||{},n=r.pathParameters||{},o=decodeURIComponent(n.type||""),s=decodeURIComponent(n.id||""),u=(s||"GET"!==r.httpMethod?r.httpMethod:"LIST")||"",c=decodeURIComponent(n.cmd||""),d=!u&&r.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[u],a=r.body&&("string"==typeof r.body&&(r.body.startsWith("{")||r.body.startsWith("["))?JSON.parse(r.body):r.body)||r.Records&&{records:r.Records}||null;!a&&P(E,"#"+d+":"+c+" ("+u+", "+o+"/"+s+")...."),a&&P(E,"#"+d+":"+c+" ("+u+", "+o+"/"+s+").... body.len=",a?_.json(a).length:-1);var f={_id:s,_type:o,_param:i,_body:a,_ctx:e},l=Promise.resolve(f),m=function(r,e,t,i){var n=null;switch(r){case"LIST":n=p;break;case"GET":"0"!==t&&"enable"===i?n=h:"0"!==t&&"disable"===i?n=y:"0"!==t&&"confirm"===i?n=v:"!"===t&&""===i?n=O:t.startsWith("!")&&""===i?n=S:"0"!==t&&""===i&&(n=q);break;case"PUT":t.startsWith("!")||"0"!==t&&""===i&&(n=T);break;case"POST":t.startsWith("!")&&""===i?n=I:t.startsWith("!")&&"user"===i&&(n=D)}return n}(d,0,s,c);if(!m)return t(null,w({MODE:d}));try{l.then(function(r){var e=r._id,t=r._type,i=r._param,n=r._body,o=r._ctx;return m(t,e,i,n,o)}).then(function(r){return r&&"object"===(void 0===r?"undefined":_typeof(r))&&(r=_.cleanup(r)),t(null,j(200,r)),!0}).catch(function(r){return 0<=(r&&r.message||"").indexOf("404 NOT FOUND")?t(null,w(r.message)):(g(E,"!!! callback@1-2 with err",r),t(null,b(r.message||r))),!1})}catch(r){t(r,b(r.message))}}};