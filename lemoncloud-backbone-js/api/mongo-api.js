"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}exports=module.exports=function(e,r){if(!e)throw new Error("_$(global instance pool) is required!");var t=e._,_=e.U,m=e.GS;if(!t)throw new Error("$_ is required!");var E=_.NS(r||"MONG","yellow"),P=e.log,y=(e.inf,e.err);function b(e){return j(404,e)}function p(e){return j(503,e)}function j(e,r){return{statusCode:e,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:JSON.stringify(r)}}var i=function(e,r,t){r.callbackWaitsForEmptyEventLoop=!1;var i=e.queryStringParameters||{},n=e.pathParameters||{},o=decodeURIComponent(n.type||""),s=decodeURIComponent(n.id||""),d=(s||"GET"!==e.httpMethod?e.httpMethod:"LIST")||"",u=decodeURIComponent(n.cmd||""),a=!d&&e.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[d],c=e.body&&("string"==typeof e.body&&(e.body.startsWith("{")||e.body.startsWith("["))?JSON.parse(e.body):e.body)||e.Records&&{records:e.Records}||null;!c&&P(E,"#"+a+":"+u+" ("+d+", "+o+"/"+s+")...."),c&&P(E,"#"+a+":"+u+" ("+d+", "+o+"/"+s+").... body.len=",c?_.json(c).length:-1);var l={_id:s,_type:o,_param:i,_body:c,_ctx:r},m=Promise.resolve(l),f=function(e,r,t,i){var n=null;switch(e){case"SEARCH":break;case"GET":"0"===t&&"create-table"===i&&(n=g),"0"===t&&"delete-table"===i&&(n=v),"0"===t&&"list-table"===i&&(n=w),"0"===t&&"stream"===i&&(n=N),"0"===t&&"test-self"===i&&(n=T),"0"!==t&&""===i&&(n=h);break;case"PUT":"0"!==t&&"increment"===i&&(n=S),"0"!==t&&""===i&&(n=I);break;case"POST":n=q;break;case"DELETE":"0"!==t&&""===i&&(n=O)}return n}(a,0,s,u);if(!f)return t(null,b({MODE:a}));try{m.then(function(e){var r=e._id,t=e._type,i=e._param,n=e._body,o=e._ctx;return f(t,r,i,n,o)}).then(function(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))&&(e=_.cleanup(e)),t(null,j(200,e)),!0}).catch(function(e){return 0<=(e&&e.message||"").indexOf("404 NOT FOUND")?t(null,b(e.message)):(y(E,"!!! callback@1-2 with err",e),t(null,p(e.message||e))),!1})}catch(e){t(e,p(e.message))}};function g(e,r,t,i,n){if(P(E,"do_get_create_table("+e+"/"+r+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=_.N(r,0);var s=o.idName||"id",d=o.idType||"Number";return"string"!=typeof s||s.length<1?Promise.reject(new Error("invalid idName:"+s)):"string"!=typeof d||d.length<1?Promise.reject(new Error("invalid idType:"+d)):m.do_create_table(e,s,d).then(function(e){return P(E,"> create-table :=",e),o.result=e,o})}function v(e,r,t,i,n){if(P(E,"do_get_delete_table("+e+"/"+r+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};return o?(o._id=_.N(r,0),m.do_delete_table(e).then(function(e){return P(E,"> delete-table :=",e),o.result=e,o})):Promise.reject(new Error("node is required!"))}function w(e,r,t,i,n){if(P(E,"do_get_list_table("+e+"/"+r+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=_.N(r,0);var s="#"===e?"":e,d=_.N(o.limit,0);return m.do_list_tables(s,d).then(function(e){return P(E,"> list-table :=",e),o.result=e,o})}function N(e,r,t,i,n){if(P(E,"do_get_read_stream("+e+"/"+r+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};return o?(o._id=_.N(r,0),o.table=e,m.do_read_stream(o).then(function(e){return P(E,"> read-stream :=",e),e})):Promise.reject(new Error("node is required!"))}function T(e,r,t,i,n){if(P(E,"do_get_test_self("+e+"/"+r+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};return o?(o._id=_.N(r,0),m.do_test_self(t).then(function(e){return P(E,"> test-self :=",e),o.result=e,o})):Promise.reject(new Error("node is required!"))}function h(r,e,t,i,n){if(P(E,"do_get_read_item("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=_.N(e,0);var s=o.idName||"id",d=o.idType||"Number";if("string"!=typeof s||s.length<1)return Promise.reject(new Error("invalid idName:"+s));if("string"!=typeof d||d.length<1)return Promise.reject(new Error("invalid idType:"+d));var u=r,a="Number"===d&&_.N(e,0)||e;return m.do_get_item(u,_defineProperty({},s,a)).then(function(e){return P(E,"> get-item["+r+"] :=",e),o.result=e,o})}function q(r,e,t,i,n){if(P(E,"do_post_create_item("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));if(!i)return Promise.reject(new Error("$body is required!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=_.N(e,0);var s=o.idName||"id",d=o.idType||"Number";if("string"!=typeof s||s.length<1)return Promise.reject(new Error("invalid idName:"+s));if("string"!=typeof d||d.length<1)return Promise.reject(new Error("invalid idType:"+d));var u=r,a="Number"===d&&_.N(e,0)||e,c=i;return m.do_create_item(u,_defineProperty({},s,a),c).then(function(e){return P(E,"> create-item["+r+"] :=",e),o.result=e,o})}function O(r,e,t,i,n){if(P(E,"do_delete_item("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=_.N(e,0);var s=o.idName||"id",d=o.idType||"Number";if("string"!=typeof s||s.length<1)return Promise.reject(new Error("invalid idName:"+s));if("string"!=typeof d||d.length<1)return Promise.reject(new Error("invalid idType:"+d));var u=r,a="Number"===d&&_.N(e,0)||e;return m.do_delete_item(u,_defineProperty({},s,a)).then(function(e){return P(E,"> delete-item["+r+"] :=",e),o.result=e,o})}function I(r,e,t,i,n){if(P(E,"do_put_update_item("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=_.N(e,0);var s=o.idName||"id",d=o.idType||"Number";if("string"!=typeof s||s.length<1)return Promise.reject(new Error("invalid idName:"+s));if("string"!=typeof d||d.length<1)return Promise.reject(new Error("invalid idType:"+d));var u=r,a="Number"===d&&_.N(e,0)||e,c=i,l=i.$I||void 0;return delete i.$I,m.do_update_item(u,_defineProperty({},s,a),c,l).then(function(e){return P(E,"> update-item["+r+"] :=",e),o.result=e,o})}function S(r,e,t,i,n){if(P(E,"do_put_increment_item("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=_.N(e,0);var s=o.idName||"id",d=o.idType||"Number";if("string"!=typeof s||s.length<1)return Promise.reject(new Error("invalid idName:"+s));if("string"!=typeof d||d.length<1)return Promise.reject(new Error("invalid idType:"+d));var u=r,a="Number"===d&&_.N(e,0)||e,c=i,l=i.$I||void 0;return delete i.$I,m.do_increment_item(u,_defineProperty({},s,a),c,l).then(function(e){return P(E,"> increment-item["+r+"] :=",e),o.result=e,o})}return i.do_get_create_table=g,i};