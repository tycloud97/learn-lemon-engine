"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports=module.exports=function(e,r){if(!e)throw new Error("_$(global instance pool) is required!");var t=e._,y=e.U,u=e.MS;if(!t)throw new Error("$_ is required!");var m=y.NS(r||"MSQL","yellow"),p=e.log,E=(e.inf,e.err);function b(e){return w(404,e)}function g(e){return w(503,e)}function w(e,r){return{statusCode:e,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:JSON.stringify(r)}}var n=function(e,r,t){r.callbackWaitsForEmptyEventLoop=!1;var n=e.queryStringParameters||{},i=e.pathParameters||{},o=decodeURIComponent(i.type||""),s=decodeURIComponent(i.id||""),d=(s||"GET"!==e.httpMethod?e.httpMethod:"LIST")||"",u=decodeURIComponent(i.cmd||""),c=!d&&e.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[d],a=e.body&&("string"==typeof e.body&&(e.body.startsWith("{")||e.body.startsWith("["))?JSON.parse(e.body):e.body)||e.Records&&{records:e.Records}||null;!a&&p(m,"#"+c+":"+u+" ("+d+", "+o+"/"+s+")...."),a&&p(m,"#"+c+":"+u+" ("+d+", "+o+"/"+s+").... body.len=",a?y.json(a).length:-1);var l={_id:s,_type:o,_param:n,_body:a,_ctx:r},_=Promise.resolve(l),f=function(e,r,t,n){var i=null;switch(e){case"LIST":break;case"GET":"0"===t&&"last-id"===n&&(i=v),"0"===t&&"next-id"===n&&(i=j),"0"===t&&"create-id"===n&&(i=P),"0"===t&&"delete-id"===n&&(i=h),"0"===t&&"query"===n&&(i=q)}return i}(c,0,s,u);if(!f)return t(null,b({MODE:c}));try{_.then(function(e){var r=e._id,t=e._type,n=e._param,i=e._body,o=e._ctx;return f(t,r,n,i,o)}).then(function(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))&&(e=y.cleanup(e)),t(null,w(200,e)),!0}).catch(function(e){return 0<=(e&&e.message||"").indexOf("404 NOT FOUND")?t(null,b(e.message)):(E(m,"!!! callback@1-2 with err",e),t(null,g(e.message||e))),!1})}catch(e){t(e,g(e.message))}};function v(e,r,t,n,i){if(p(m,"do_get_last_id("+e+"/"+r+")...."),!e)return Promise.reject(new Error("type is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};return o?(o._id=y.N(r,0),u.do_get_last_id(e).then(function(e){return p(m,"> last-id :=",e),o.result=e,o})):Promise.reject(new Error("node is required!"))}function j(e,r,t,n,i){if(p(m,"do_get_next_id("+e+"/"+r+")...."),!e)return Promise.reject(new Error("type is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};return o?(o._id=y.N(r,0),u.do_get_next_id(e).then(function(e){return p(m,"> next-id :=",e),o.result=e,o})):Promise.reject(new Error("node is required!"))}function P(e,r,t,n,i){if(p(m,"do_get_create_id("+e+"/"+r+")...."),!e)return Promise.reject(new Error("type is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=y.N(r,0);var s=y.N(o.next,1e3);return u.do_create_id_seq(e,s).then(function(e){return p(m,"> create-id :=",e),o.result=e,o})}function h(e,r,t,n,i){if(p(m,"do_get_delete_id("+e+"/"+r+")...."),!e)return Promise.reject(new Error("type is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};return o?(o._id=y.N(r,0),u.do_delete_id_seq(e).then(function(e){return p(m,"> delete-id :=",e),o.result=e,o})):Promise.reject(new Error("node is required!"))}function q(e,r,t,n,i){if(p(m,"do_get_delete_id("+e+"/"+r+")...."),!e)return Promise.reject(new Error("type is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=y.N(r,0);var s=o.query,d=o.values;return s?d&&!Array.isArray(d)?Promise.reject(new Error(m+":values should be array!")):u.do_promise_query(s,d).then(function(e){return p(m,"> promise-query :=",e),o.result=e,o}):Promise.reject(new Error(m+":query is required"))}return n.do_get_last_id=v,n.do_get_next_id=j,n.do_get_create_id=P,n.do_get_delete_id=h,n};