"use strict";var _slicedToArray=function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var o=[],t=!0,n=!1,s=void 0;try{for(var a,i=e[Symbol.iterator]();!(t=(a=i.next()).done)&&(o.push(a.value),!r||o.length!==r);t=!0);}catch(e){n=!0,s=e}finally{try{!t&&i.return&&i.return()}finally{if(n)throw s}}return o}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports=module.exports=function(_$,name){if(!_$)throw new Error("_$(global instance pool) is required!");var $_=_$._,$U=_$.U;if(!$U)throw new Error("$U is required!");var NS=$U.NS(name||"PROT","yellow"),$lambda=function(){if(!_$.LS)throw new Error("$LS(lambda-service) is required!");return _$.LS},$sns=function(){return _$.SN?_$.SN:Promise.reject(new Error("$SN(sns-service) is required"))};function success(e){return buildResponse(200,e)}function notfound(e){return buildResponse(404,e)}function failure(e){return buildResponse(503,e)}function buildResponse(e,r){return{statusCode:e,headers:{"Content-Type":"string"==typeof r?"text/plain; charset=utf-8":"application/json; charset=utf-8","Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:"string"==typeof r?r:JSON.stringify(r)}}var main=function(e,r,o){r.callbackWaitsForEmptyEventLoop=!1;var t=e.queryStringParameters||{},n=e.pathParameters||{},s=decodeURIComponent(n.type||""),a=decodeURIComponent(n.id||""),i=(a||"GET"!==e.httpMethod?e.httpMethod:"LIST")||"",c=decodeURIComponent(n.cmd||""),u=!i&&e.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[i],l=e.body&&("string"==typeof e.body&&(e.body.startsWith("{")||e.body.startsWith("["))?JSON.parse(e.body):e.body)||e.Records&&{records:e.Records}||null;!l&&_log(NS,"#"+u+":"+c+" ("+i+", "+s+"/"+a+")...."),l&&_log(NS,"#"+u+":"+c+" ("+i+", "+s+"/"+a+").... body.len=",l?$U.json(l).length:-1);var m={_id:a,_param:t,_body:l,_event:e,_ctx:r},_=Promise.resolve(m),p=_decode_next_handler(u,a,c);if(!p)return o(null,notfound({MODE:u}));try{_.then(function(e){var r=e._id,o=e._param,t=e._body,n=e._ctx,s=e._event;return p(r,o,t,n,s)}).then(function(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))&&(e=$U.cleanup(e)),o(null,success(e)),!0}).catch(function(e){return _err(NS,"!!! callback@1 with err",e),0<=(e&&e.message||"").indexOf("404 NOT FOUND")?o(null,notfound(e.message)):o(null,failure(e.message||e)),!1})}catch(e){o(e,failure(e.message))}};function _decode_next_handler(e,r,o){var t=null;switch(e){case"LIST":break;case"GET":""!==r&&""===o?t=do_get_protocol:"0"===r&&"self-test"===o?t=do_self_test_protocol:"!"===r&&"execute"===o?t=do_get_execute_protocol:"!"===r&&"notify"===o&&(t=do_get_notify_protocol);break;case"PUT":break;case"POST":"!"===r&&"execute"===o?t=do_post_execute_protocol:"!"===r&&"notify"===o&&(t=do_post_notify_protocol)}return t}main.do_get_protocol=do_get_protocol,main.do_execute=do_execute_protocol,main.do_notify=do_notify_protocol;var URL=require("url"),QUERY_STRING=require("query-string"),my_parse_query=function my_parse_query(query){var param=null,error=null;if(!query)return param;if(query.startsWith("[")&&query.endsWith("]")?query=decodeURIComponent(query):query.startsWith("%7B")&&query.endsWith("%7D")&&(query=decodeURIComponent(query)),query.startsWith("{")&&query.endsWith("}")||query.startsWith("[")&&query.endsWith("]"))try{param=JSON.parse(query)}catch(e){var emsg=e&&e.message||""+e;if(emsg.startsWith("Unexpected token"))try{param=eval("(()=>{return "+query+"})()")}catch(e){error=e}else _err(NS,"! ERR=",emsg||e),error=e}else param=QUERY_STRING.parse(query),Object.keys(param).forEach(function(e){null===param[e]&&(param[e]="")});if(error&&_err(NS,"> parse["+query+"].ERR = ",error),!error&&_log(NS,"> parse["+query+"] = ",param),error)throw error;return param},my_chain_parse_url=function(e){if(!e)return Promise.reject(new Error("url is required!"));var r=URL.parse(e,!1),o=r.auth||"",t=r.hostname||"",n=r.protocol||"",s=r.query||"",a=r.hash||"",i=r.pathname||"";if("lemon:"!==n)return Promise.reject(new Error("invalid protocol:"+n));var c=i.split("/",4);if(_log("> path["+i+"] =",c),""!==c[0])return Promise.reject(new Error("invalid path:"+i));var u={};return u.path=i,u.type=c[1]||"",u.id=c[2],u.cmd=c[3],u.query=s,u.param=my_parse_query(s)||{},u.hash=a,u.body=a.startsWith("#")?my_parse_query(a.substr(1)):void 0,u.method=a.startsWith("#")?"post":"get",u.sid=o,u.service=t,void 0===u.id&&delete u.id,void 0===u.cmd&&delete u.cmd,void 0===u.param&&delete u.param,void 0===u.body&&delete u.body,_log(NS,"> parse("+e+") =",$U.json(u)),Promise.resolve(u)},MAP_LAMBDA_FUNCTION={"messages/chat":"chat","messages/sheetmsg":"sheetmsg","messages/inquiry":"inquiry","messages/mail":"mail","messages/role":"role","messages/user":"user","messages/group":"group","item-pools/pools":"item-pools","item-pools/tasks":"item-tasks","item-pools/metric":"item-metric","item-pools/trace":"item-trace","sheets/sheets":"sheets","imweb-pools/items":"items","imweb-pools/goods":"goods","imweb-pools/orders":"orders","imweb-pools/answers":"answers","imweb-pools/coupons":"coupons","imweb-pools/loopers":"loopers","imweb-pools/shops":"shops","imweb-pools/naver":"naver","imweb-pools/daum":"daum","queue/batch":"queue.batch","queue/trace":"queue.trace","carrot/horse":"horse","carrot/pedigree":"carrot_pedigree","carrot/profile":"carrot_profile","carrot/nicks":"carrot_nicks","carrot/line":"carrot_line","carrot-msg/chat":"carrot_chat","carrot-msg/role":"carrot_role","carrot-msg/user":"carrot_user","carrot-msg/group":"carrot_group","push-notification/push":"push","chatbot/slack":"slack","chatbot/kakao":"kakao"},MAP_TOPIC_NAME={protocol:"protocol",messages:"messages","imweb-pools":"imweb-pools",queue:"queue","item-pools":"item-pools",sheets:"sheets","push-notification":"push",carrot:"carrot","carrot-messages":"carrot-messages",chatbot:"chatbot"},my_chain_execute_protocol=function(e){_log(NS,"my_chain_execute_protocol()....");var a=e.sid||"",r=e.service||"",o=e.type||"",t=r+(o?"/"+o:""),i=MAP_LAMBDA_FUNCTION[t]||"";return i?Promise.resolve(e).then(function(e){var r=e.id,o=e.cmd,t=e.param||{},n=e.body,s=e.method||"get";return a&&(t.sid=a),"post"===s||"POST"===s?$lambda().do_post(i,r,o,t,n):$lambda().do_get(i,r,o,t,n)}).catch(function(e){throw _err(NS,"ERR! =",e),e}):Promise.reject(new Error("FUNC is invalid (check MAP_LAMBDA_FUNCTION): "+t))},my_chain_notify_protocol=function(e){_log(NS,"my_chain_notify_protocol()....");var r=e.sid||"",o=e.service||"",t=(e.type,MAP_TOPIC_NAME[o]),n=e.param||{};return r&&(n.sid=r),t?$sns().do_publish(t,"Lemon Protocol",e):my_chain_execute_protocol(e)};function do_get_protocol(e,r,o,t,n){return(e=(""+e).trim())?Promise.resolve({id:e,param:r}):Promise.reject(new Error("Invalid ID:"+e))}function do_get_execute_protocol(e,r,o,t,n){if("!"!==e)return Promise.reject(new Error("Invalid ID:"+e));var s=(r=r||{}).url||"";return s?Promise.resolve(s).then(my_chain_parse_url).then(my_chain_execute_protocol):Promise.reject(new Error("Param.url is required!"))}function do_post_execute_protocol(e,r,o,t,n){if("!"!==e)return Promise.reject(new Error("Invalid ID:"+e));var s=(r=r||{}).url||"";if(!s)return Promise.reject(new Error("Param.url is required!"));var a=o;return Promise.resolve(s).then(my_chain_parse_url).then(function(e){return e.method="post",e.body=a,e}).then(my_chain_execute_protocol)}function do_get_notify_protocol(e,r,o,t,n){if("!"!==e)return Promise.reject(new Error("Invalid ID:"+e));var s=(r=r||{}).url||"",a=r.callback||"";return s?Promise.resolve(s).then(my_chain_parse_url).then(function(e){return e.callback=a,e}).then(my_chain_notify_protocol):Promise.reject(new Error("Param.url is required!"))}function do_post_notify_protocol(e,r,o,t,n){if("!"!==e)return Promise.reject(new Error("Invalid ID:"+e));var s=(r=r||{}).url?[r.url,o]:[(o=o||{}).url||"",o.body||"",o.callback||""],a=_slicedToArray(s,3),i=a[0],c=a[1],u=a[2];return i?Promise.resolve(i).then(my_chain_parse_url).then(function(e){return e.method="post",e.body=c,e.callback=u,e}).then(my_chain_notify_protocol):Promise.reject(new Error(".url is required!"))}function do_execute_protocol(e){return e?Promise.resolve(e).then(my_chain_parse_url).then(my_chain_execute_protocol):Promise.reject(new Error("url is required!"))}function do_notify_protocol(e){return e?Promise.resolve(e).then(my_chain_parse_url).then(my_chain_notify_protocol):Promise.reject(new Error("url is required!"))}function do_self_test_protocol(e,r,o,t,n){return Promise.resolve(r).then(function(){var e=["lemon://abc@protocol/?a=b&c","lemon://abc@protocol/0?a=b&c#{}",'lemon://abc@protocol///1?{a:1,b:null}#{"a":"b"}','lemon://abc@protocol//0/1/2?{"a":1,"b":null}#[]',"lemon://abc@protocol//0?{}","lemon://abc@protocol//0?[]#{a:2}","lemon://abc@protocol//0/?%7B%7D#[{a:2}]"].map(my_chain_parse_url);return Promise.all(e)})}return main};