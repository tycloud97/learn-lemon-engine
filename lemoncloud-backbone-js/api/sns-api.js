"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r};exports=module.exports=function(r,e){if(!r)throw new Error("_$(global instance pool) is required!");var t=r._,y=r.U,d=r.SN;if(!t)throw new Error("$_ is required!");if(!d)throw new Error("$SN is required!");var b=y.NS(e||"SNSS","yellow"),p=r.log,E=(r.inf,r.err);function h(r){return _(404,r)}function P(r){return _(503,r)}function _(r,e){return{statusCode:r,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:JSON.stringify(e)}}function S(e,r,t,o,n){if(p(b,"do_publish("+e+"/"+r+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if(!r)return Promise.reject(new Error("ID is required!"));if(!o)return Promise.reject(new Error("$body is required!"));if("sms"==e||"SMS"==e)return w(e,r,t,o,n);var s=t?Object.assign({},t):{};if(!s)return Promise.reject(new Error("node is required!"));var i=t.subject||"";return p(b,"> body =",o),d.do_publish(e,i,o).then(function(r){return p(b,"> pub-message["+e+"] :=",r),s.result=r,s})}function w(e,r,t,o,n){if(p(b,"do_publish_sms("+e+"/"+r+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if(!r)return Promise.reject(new Error("ID is required!"));if(!o)return Promise.reject(new Error("$body is required!"));var s=Object.assign(t||{},o||{});if(!s)return Promise.reject(new Error("node is required!"));var i=s.phone||"",u=s.message||"",c=s.sender||"";return d.do_publish_sms(i,u,c).then(function(r){return p(b,"> sms-message["+e+"] :=",r),s.result=r,s})}function T(r,e,t,o,n){if(p(b,"do_get_test_self("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if("0"!==e)return Promise.reject(new Error("ID is invalid!"));var s=t?Object.assign({},t):{};return s?Promise.resolve(s):Promise.reject(new Error("node is required!"))}return function(r,e,t){e.callbackWaitsForEmptyEventLoop=!1;var o=r.queryStringParameters||{},n=r.pathParameters||{},s=decodeURIComponent(n.type||""),i=decodeURIComponent(n.id||""),u=(i||"GET"!==r.httpMethod?r.httpMethod:"LIST")||"",c=decodeURIComponent(n.cmd||""),d=!u&&r.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[u],a=r.body&&("string"==typeof r.body&&(r.body.startsWith("{")||r.body.startsWith("["))?JSON.parse(r.body):r.body)||r.Records&&{records:r.Records}||null;!a&&p(b,"#"+d+":"+c+" ("+u+", "+s+"/"+i+")...."),a&&p(b,"#"+d+":"+c+" ("+u+", "+s+"/"+i+").... body.len=",a?y.json(a).length:-1);var l={_id:i,_type:s,_param:o,_body:a,_ctx:e},f=Promise.resolve(l),m=function(r,e,t,o){var n=null;switch(r){case"LIST":break;case"GET":"0"===t&&"test-self"===o&&(n=T);break;case"PUT":break;case"POST":"0"===t&&""===o?n=S:"0"===t&&"sms"===o&&(n=w)}return n}(d,0,i,c);if(!m)return t(null,h({MODE:d}));try{f.then(function(r){var e=r._id,t=r._type,o=r._param,n=r._body,s=r._ctx;return m(t,e,o,n,s)}).then(function(r){return r&&"object"===(void 0===r?"undefined":_typeof(r))&&(r=y.cleanup(r)),t(null,_(200,r)),!0}).catch(function(r){return E(b,"!!! callback@1 with err",r),0<=(r&&r.message||"").indexOf("404 NOT FOUND")?t(null,h(r.message)):t(null,P(r.message||r)),!1})}catch(r){t(r,P(r.message))}}};