"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports=module.exports=function(e,r){if(!e)throw new Error("_$(global instance pool) is required!");var t=e._,l=e.U,a=e.ES6;if(!t)throw new Error("$_ is required!");if(!a)throw new Error("$ES6 is required!");var E=l.NS(r||"ES62","yellow"),p=e.log,P=(e.inf,e.err);function y(e){return w(404,e)}function j(e){return w(503,e)}function w(e,r){return{statusCode:e,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:JSON.stringify(r)}}var i=function(e,r,t){r.callbackWaitsForEmptyEventLoop=!1;var i=e.queryStringParameters||{},n=e.pathParameters||{},o=decodeURIComponent(n.type||""),s=decodeURIComponent(n.id||""),u=(s||"GET"!==e.httpMethod?e.httpMethod:"LIST")||"",d=decodeURIComponent(n.cmd||""),c=!u&&e.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[u],a=e.body&&("string"==typeof e.body&&(e.body.startsWith("{")||e.body.startsWith("["))?JSON.parse(e.body):e.body)||e.Records&&{records:e.Records}||null;!a&&p(E,"#"+c+":"+d+" ("+u+", "+o+"/"+s+")...."),a&&p(E,"#"+c+":"+d+" ("+u+", "+o+"/"+s+").... body.len=",a?l.json(a).length:-1);var f={_id:s,_type:o,_param:i,_body:a,_ctx:r},_=Promise.resolve(f),m=function(e,r,t,i){var n=null;switch(e){case"LIST":""===t&&""===i&&(n=S);break;case"GET":"0"===t&&"test-self"===i&&(n=I),""!==t&&""===i&&(n=T);break;case"PUT":""!==t&&""===i&&(n=g);break;case"POST":"0"===t&&"create-index"===i&&(n=b),"0"===t&&"delete-index"===i&&(n=h),""!==t&&"push"===i&&(n=v),""!==t&&""===i&&(n=q);break;case"DELETE":""!==t&&""===i&&(n=O)}return n}(c,0,s,d);if(!m)return t(null,y({MODE:c}));try{_.then(function(e){var r=e._id,t=e._type,i=e._param,n=e._body,o=e._ctx;return m(t,r,i,n,o)}).then(function(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))&&(e=l.cleanup(e)),t(null,w(200,e)),!0}).catch(function(e){return 0<=(e&&e.message||"").indexOf("404 NOT FOUND")?t(null,y(e.message)):(P(E,"!!! callback@1-2 with err",e),t(null,j(e.message||e))),!1})}catch(e){t(e,j(e.message))}};function b(e,r,t,i,n){if(p(E,"do_get_create_index("+e+"/"+r+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=l.N(r,0);var s=e,u=i||t;return p(E,"> options =",JSON.stringify(u)),a.do_create_index_type(s,"",u).then(function(e){return p(E,"> create-index :=",e),o.result=e,o})}function h(e,r,t,i,n){if(p(E,"do_get_delete_index("+e+"/"+r+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=l.N(r,0);var s=e,u=i||t;return a.do_delete_index_type(s,"",u).then(function(e){return p(E,"> delete-index :=",e),o.result=e,o})}function q(r,e,t,i,n){if(p(E,"do_post_create_item("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));if(!i)return Promise.reject(new Error("$body is required!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=l.N(e,0);var s=r,u=o.$type||"",d=e,c=i;return a.do_create_item(s,u,d,c).then(function(e){return p(E,"> create-item["+r+"] :=",e),o.result=e,o})}function v(r,e,t,i,n){if(p(E,"do_post_push_item("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));if(!i)return Promise.reject(new Error("$body is required!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=l.N(e,0);var s=r,u=o.$type||"",d=i,c="0"===e?"":e;return a.do_push_item(s,u,d,c).then(function(e){return p(E,"> push-item["+r+"] :=",e),o.result=e,o})}function g(r,e,t,i,n){if(p(E,"do_put_update_item("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));if(!i)return Promise.reject(new Error("$body is required!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=l.N(e,0);var s=r,u=o.$type||"",d=e,c=i;return a.do_update_item(s,u,d,c).then(function(e){return p(E,"> update-item["+r+"] :=",e),o.result=e,o})}function T(r,e,t,i,n){if(p(E,"do_get_read_item("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=l.N(e,0);var s=r,u=o.$type||"",d=e,c=i;return a.do_get_item(s,u,d,c).then(function(e){return p(E,"> get-item["+r+"] :=",e),o.result=e,o})}function O(r,e,t,i,n){if(p(E,"do_delete_item("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=l.N(e,0);var s=r,u=o.$type||"",d=e;return a.do_delete_item(s,u,d).then(function(e){return p(E,"> delete-item["+r+"] :=",e),o.result=e,o})}function S(r,e,t,i,n){if(p(E,"do_search_item("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(e)return Promise.reject(new Error("ID is not required!"));var o=t?Object.assign({},t):{};if(!o)return Promise.reject(new Error("node is required!"));o._id=l.N(e,0);var s=r,u=o.$type||"",d=t;return delete d.$type,a.do_search_item(s,u,d).then(function(e){return p(E,"> search-item["+r+"].took :=",e&&e.took||0,", hits =",e&&e.hits&&e.hits.total||0),o.result=e,o})}function I(e,r,t,i,n){if(p(E,"do_get_test_self("+e+"/"+r+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var o=t?Object.assign({},t):{};return o?(o._id=l.N(r,0),a.do_test_self(o).then(function(e){return p(E,"> test-self :=",e),o.result=e,o})):Promise.reject(new Error("node is required!"))}return i.do_get_create_index=b,i};