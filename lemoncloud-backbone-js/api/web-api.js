"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports=module.exports=function(e,r){if(!e)throw new Error("_$(global instance pool) is required!");var t=e._,E=e.U,s=e.WS;if(!t)throw new Error("$_ is required!");if(!s)throw new Error("$WS is required!");var b=E.NS(r||"WEBS","yellow"),p=e.log,m=(e.inf,e.err);function h(e){return P(404,e)}function w(e){return P(503,e)}function P(e,r){return{statusCode:e,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:JSON.stringify(r)}}function T(r,e,t,o,n){if(p(b,"do_handleGet("+r+"/"+e+")...."),e=e||"",!r)return Promise.reject(new Error("TYPE is required!"));var i=t?Object.assign({},t):{};return i?s.do_get(r,e,void 0,t).then(function(e){return p(b,"> web-get["+r+"] :=",e),i.result=e,i}):Promise.reject(new Error("node is required!"))}function _(r,e,t,o,n){if(p(b,"do_handlePut("+r+"/"+e+")...."),e=e||"",!r)return Promise.reject(new Error("TYPE is required!"));var i=t?Object.assign({},t):{};return i?s.do_put(r,e,void 0,t,o).then(function(e){return p(b,"> web-put["+r+"] :=",e),i.result=e,i}):Promise.reject(new Error("node is required!"))}function S(r,e,t,o,n){if(p(b,"do_handlePost("+r+"/"+e+")...."),e=e||"",!r)return Promise.reject(new Error("TYPE is required!"));var i=t?Object.assign({},t):{};return i?s.do_post(r,e,void 0,t,o).then(function(e){return p(b,"> web-post["+r+"] :=",e),i.result=e,i}):Promise.reject(new Error("node is required!"))}function v(r,e,t,o,n){if(p(b,"do_handleDelete("+r+"/"+e+")...."),e=e||"",!r)return Promise.reject(new Error("TYPE is required!"));var i=t?Object.assign({},t):{};return i?s.do_delete(r,e,void 0,t,o).then(function(e){return p(b,"> web-del["+r+"] :=",e),i.result=e,i}):Promise.reject(new Error("node is required!"))}return function(e,r,t){r.callbackWaitsForEmptyEventLoop=!1;var o=e.queryStringParameters||{},n=e.pathParameters||{},i=decodeURIComponent(n.type||""),s=decodeURIComponent(n.id||""),u=(s||"GET"!==e.httpMethod?e.httpMethod:"LIST")||"",c=decodeURIComponent(n.cmd||""),d=!u&&e.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[u],a=e.body&&("string"==typeof e.body&&(e.body.startsWith("{")||e.body.startsWith("["))?JSON.parse(e.body):e.body)||e.Records&&{records:e.Records}||null;!a&&p(b,"#"+d+":"+c+" ("+u+", "+i+"/"+s+")...."),a&&p(b,"#"+d+":"+c+" ("+u+", "+i+"/"+s+").... body.len=",a?E.json(a).length:-1);var l={_id:s,_type:i,_param:o,_body:a,_ctx:r},f=Promise.resolve(l),y=function(e,r,t,o){var n=null;switch(e){case"LIST":case"GET":n=T;break;case"PUT":n=_;break;case"POST":n=S;break;case"DELETE":n=v}return n}(d);if(!y)return t(null,h({MODE:d}));try{f.then(function(e){var r=e._id,t=e._type,o=e._param,n=e._body,i=e._ctx;return y(t,r,o,n,i)}).then(function(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))&&(e=E.cleanup(e)),t(null,P(200,e)),!0}).catch(function(e){return 0<=(e&&e.message||"").indexOf("404 NOT FOUND")?t(null,h(e.message)):(m(b,"!!! callback@1-2 with err",e),t(null,w(e.message||e))),!1})}catch(e){t(e,w(e.message))}}};