"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports=module.exports=function(a,e){if(!a)throw new Error("_$(global instance pool) is required!");var r=a._,E=a.U,u=a.SS;if(!r)throw new Error("$_ is required!");if(!u)throw new Error("$SS is required!");var w=E.NS(e||"SQSS","yellow"),y=a.log,h=(a.inf,a.err);function p(e){return v(404,e)}function b(e){return v(503,e)}function v(e,r){return{statusCode:e,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0},body:JSON.stringify(r)}}function P(e,r,t,n,o){if(!e)return Promise.reject(new Error("TYPE is required!"));if(!r)return Promise.reject(new Error("ID is required!"));var i=t?Object.assign({},t):{};if(!i)return Promise.reject(new Error("node is required!"));var s=E.N(i.size,1);return u.do_receiveMessage(e,s).then(function(e){return i.result=e,i})}function T(r,e,t,n,o){if(y(w,"do_sendMessage("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));if(!n)return Promise.reject(new Error("$body is required!"));var i=t?Object.assign({},t):{};return i?u.do_sendMessage(r,t,n).then(function(e){return y(w,"> sent-message["+r+"] :=",e),i.result=e,i}):Promise.reject(new Error("node is required!"))}function _(r,e,t,n,o){if(y(w,"do_deleteMessage("+r+"/"+e+")...."),!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));var i=t?Object.assign({},t):{};return i?u.do_deleteMessage(r,e).then(function(e){return y(w,"> del-message["+r+"] :=",e),i.result=e,i}):Promise.reject(new Error("node is required!"))}function g(r,e,t,n,o){if(!r)return Promise.reject(new Error("TYPE is required!"));if(!e)return Promise.reject(new Error("ID is required!"));var i=t?Object.assign({},t):{};return i?u.do_statistics(r).then(function(e){return y(w,"> stat["+r+"] = A:"+(e.available||0)+" F:"+(e.inflight||0)+" D:"+(e.delayed||0)+" TO:"+(e.timeout||0)),i.result=e,i}):Promise.reject(new Error("node is required!"))}function j(e,r,t,n,o){if(y(w,"do_get_test_self("+e+"/"+r+")...."),!e)return Promise.reject(new Error("TYPE is required!"));if("0"!==r)return Promise.reject(new Error("ID is invalid!"));var i=t?Object.assign({},t):{};if(!i)return Promise.reject(new Error("node is required!"));var s=require("../service/task-service")(a);return Promise.resolve(i).then(function(e){y(w,"-------- task creation: ");return s.do_create_task("Test",-1,{name:"test",val:123,hi:"world"}).then(function(e){if(y(w,"> create-task =",e),!e.MessageId)throw new Error("invalid MessageId");return e})}).then(function(e){y(w,"-------- task fetch: ");return s.do_receive_task(-1,1).then(function(e){if(y(w,"> receive-task =",e),!e.Tasks)throw new Error("invalid Tasks");if(!e.Tasks[0].ReceiptHandle)throw new Error("invalid MessageId");return e.Tasks[0]})}).then(function(e){y(w,"-------- task complete: ");var r=e.ReceiptHandle;return s.do_complete_task(-1,r).then(function(e){if(y(w,"> complete-task =",e),!e.ResponseMetadata)throw new Error("invalid ResponseMetadata");return e})})}return function(e,r,t){r.callbackWaitsForEmptyEventLoop=!1;var n=e.queryStringParameters||{},o=e.pathParameters||{},i=decodeURIComponent(o.type||""),s=decodeURIComponent(o.id||""),a=(s||"GET"!==e.httpMethod?e.httpMethod:"LIST")||"",u=decodeURIComponent(o.cmd||""),c=!a&&e.Records?"EVENT":{LIST:"LIST",GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"}[a],d=e.body&&("string"==typeof e.body&&(e.body.startsWith("{")||e.body.startsWith("["))?JSON.parse(e.body):e.body)||e.Records&&{records:e.Records}||null;!d&&y(w,"#"+c+":"+u+" ("+a+", "+i+"/"+s+")...."),d&&y(w,"#"+c+":"+u+" ("+a+", "+i+"/"+s+").... body.len=",d?E.json(d).length:-1);var l={_id:s,_type:i,_param:n,_body:d,_ctx:r},f=Promise.resolve(l),m=function(e,r,t,n){var o=null;switch(e){case"LIST":break;case"GET":"0"===t&&""===n?o=P:"0"===t&&"test-self"===n?o=j:"0"===t&&"stat"===n&&(o=g);break;case"PUT":"0"===t&&""===n&&(o=T);break;case"POST":break;case"DELETE":""!==t&&""===n&&(o=_)}return o}(c,0,s,u);if(!m)return t(null,p({MODE:c}));try{f.then(function(e){var r=e._id,t=e._type,n=e._param,o=e._body,i=e._ctx;return m(t,r,n,o,i)}).then(function(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))&&(e=E.cleanup(e)),t(null,v(200,e)),!0}).catch(function(e){return 0<=(e&&e.message||"").indexOf("404 NOT FOUND")?t(null,p(e.message)):(h(w,"!!! callback@1-2 with err",e),t(null,b(e.message||e))),!1})}catch(e){t(e,b(e.message))}}};