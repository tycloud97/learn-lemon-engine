"use strict";module.exports=function(e,r){r=r||"CR";var o=e.U,n=e.aws,t=e._;if(!o)throw new Error("$U is required!");if(!n)throw new Error("$aws is required!");if(!t)throw new Error("$_ is required!");var a=e.log,u=e.inf,s=e.err,c=o.NS(r,"magenta"),i={do_list_rules:function(i,u,e){var r={Limit:i=o.N(i,10)};u&&(r.NamePrefix=u);e&&(r.NextToken=e);return a(c,"> params =",r),new Promise(function(n,t){l.listRules(r,function(e,r){return e?t(e):n(r)})}).then(function(e){var r=e.Rules||[];a(c,"> list.len =",r.length);var n=e.NextToken||"",t=r.map(v);return{limit:i,list:t,prefix:u,token:n}}).catch(function(e){throw s(c,"ERR! err=",e),e})}};i.do_describe_rule=R,i.do_enable_rule=function(r,e){if(!r)return Promise.reject(new Error("name(rule string) is required!"));e=void 0===e||e;var i={Name:r};return a(c,"> params =",i),new Promise(function(n,t){e&&l.enableRule(i,function(e,r){return e?t(e):n(r)}),e||l.disableRule(i,function(e,r){return e?t(e):n(r)})}).then(function(e){return R(r)}).catch(function(e){throw s(c,"ERR! err=",e),e})},i.do_list_targets=g,i.do_save_rule=function(n,t){if(!n)return Promise.reject(new Error("name(rule string) is required!"));if(!t)return Promise.reject(new Error("body(object) is required!"));var i="ENABLED";return R(n).catch(function(e){var r=e.message||""+e;if(r.startsWith("404 NOT FOUND"))return{};throw e}).then(function(e){var r=Object.assign(e,t);return r.name=n,r.state=t.state||i,r}).then(function(r){var e={Name:"STRING_VALUE",Description:"STRING_VALUE",EventPattern:"STRING_VALUE",RoleArn:"STRING_VALUE",ScheduleExpression:"STRING_VALUE",State:0},i=E(r);return i=Object.keys(e).reduce(function(e,r){var n=i[r];return void 0!==n&&(e[r]=n),e},{}),a(c,"> params =",i),new Promise(function(n,t){l.putRule(i,function(e,r){return e?t(e):n(r)})}).then(function(e){return a(c,"> save.res =",e),r.RuleArn=e.RuleArn||"",r})}).then(function(r){if(!r.target)return Promise.reject(new Error(".target(arn) is required!"));if(!r.arn)return Promise.reject(new Error(".rule(arn) is required!"));var e={Action:"lambda:InvokeFunction",FunctionName:r.target||"",Principal:"events.amazonaws.com",StatementId:r.name?"AWSEvents_"+r.name.replace(/[^a-zA-Z0-9-_]/gi,"_")+"_1":"",SourceArn:r.arn||""};return a(c,"> params =",e),new Promise(function(n,t){h.addPermission(e,function(e,r){return e?t(e):n(r)})}).then(function(e){return a(c,"> addPermission.res =",e),r}).catch(function(e){if(0<=(e.message||e).indexOf("already exists"))return u(c,"> The statement id provided already exists, so ignore add-permission"),r;throw e})}).then(function(r){if(!r.target)return Promise.reject(new Error(".target(arn) is required!"));if(!r.input)return Promise.reject(new Error(".input(in json string) is required!"));var e={Rule:r.name,Targets:[{Id:"1",Arn:r.target||"",Input:r.input||""}]};return a(c,"> params =",e),new Promise(function(n,t){l.putTargets(e,function(e,r){return e?t(e):n(r)})}).then(function(e){return a(c,"> putTargets.res =",e),r.TargetSaved=o.N(e.FailedEntryCount,0)<=0,r})})},e(r,i);var f={region:o.env("CR_REGION",new Error(c+":CR_REGION is required!"))},m=o.env("CR_VERSION","2015-10-07");m&&(f.apiVersion=m),a(c,"!config=",f);var d={name:"Name",arn:"Arn",description:"Description",schedule:"ScheduleExpression",pattern:"EventPattern",state:"State"},l=new n.CloudWatchEvents(f),h=new n.Lambda(f),v=function(i,e){return e=Object.keys(d).reduce(function(e,r){var n=d[r]||"",t=n&&i[n]||"";return e[r]=t,e},e||{})},E=function(i,e){return delete(e=Object.keys(d).reduce(function(e,r){var n=d[r]||"",t=i[r]||"";return e[n]=t,e},e||{})).Arn,e},w=function(n){var e=n.name||"";return e?g(e,1).then(function(e){var r=(e.list||[])[0]||{};return n.target=r.Arn||"",n.input=r.Input||"",n}):Promise.reject(new Error("name(rule string) is required!"))};function R(t){if(!t)return Promise.reject(new Error("name(rule string) is required!"));var e={Name:t};return a(c,"> params =",e),new Promise(function(n,t){l.describeRule(e,function(e,r){return e?t(e):n(r)})}).then(v).then(w).catch(function(e){s(c,"ERR! err=",e);var r=e.code||"",n=e.message||""+e;if("ResourceNotFoundException"==r||n.startsWith("Rule")&&n.endsWith("does not exist."))return Promise.reject(new Error("404 NOT FOUND - "+t));throw e})}function g(t,i,e){if(!t)return Promise.reject(new Error("name(rule string) is required!"));i=o.N(i,10);var r={Rule:t,Limit:i};return e&&(r.NextToken=e),a(c,"> params =",r),new Promise(function(n,t){l.listTargetsByRule(r,function(e,r){return e?t(e):n(r)})}).then(function(e){var r=e.Targets||[],n=e.NextToken||"";return a(c,"> list.res =",e&&e.MessageId||"#NOP"),{name:t,limit:i,list:r,token:n}}).catch(function(e){throw s(c,"ERR! err=",e),e})}return i};