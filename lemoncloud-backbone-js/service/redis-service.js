"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var t=[],n=!0,i=!1,o=void 0;try{for(var u,d=e[Symbol.iterator]();!(n=(u=d.next()).done)&&(t.push(u.value),!r||t.length!==r);n=!0);}catch(e){i=!0,o=e}finally{try{!n&&d.return&&d.return()}finally{if(i)throw o}}return t}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")};module.exports=function(e,r){r=r||"RS";var s=e.U,t=e.aws,n=e._;if(!s)throw new Error("$U is required!");if(!t)throw new Error("$aws is required!");if(!n)throw new Error("$_ is required!");var f=s.NS(r,"yellow"),a=e.log,c=e.inf,i=(e.err,{do_create_item:function(r,i,e,t){if(!r)return Promise.reject(new Error(f+"PKEY is required!"));if(!i)return Promise.reject(new Error(f+"id is required!"));if(!e)return Promise.reject(new Error(f+"item is required!"));if(!t&&a(f,"- do_create_item()...",", PKEY=",r,", id=",i,", item.len=",void 0===e?"undefined":_typeof(e),":",s.json(e).length),t&&a(f,"- do_create_item("+t+")...",", PKEY=",r,", id=",i,", item.len=",void 0===e?"undefined":_typeof(e),":",s.json(e).length),Array.isArray(r)){var o=m().pipeline(),u=Array.isArray(e)?e:[e];return r.forEach(function(e,r){var t=_(e,i),n=r<u.length?u[r]:u[u.length-1];n=n&&"object"===(void 0===n?"undefined":_typeof(n))?s.json(n):n,c(f,">> items["+r+"].set("+t+") :=",void 0===n?"undefined":_typeof(n),":",n),o=o.set(t,n)}),o.exec().then(function(e){return c(f,"> set("+r+"/"+i+") =",e),(e||[]).map(function(e){var r=_slicedToArray(e,2),t=r[0],n=r[1];return n=n&&"string"==typeof n&&n.startsWith("{")&&n.endsWith("}")?JSON.parse(n):n,t?{error:t.message||""+t}:n})})}var n=_(r,i);e=e&&"object"===(void 0===e?"undefined":_typeof(e))?s.json(e):e,c(f,"> set("+n+") =",void 0===e?"undefined":_typeof(e),":",e);var d=void 0===t||0===t?m().set(n,e):m().setex(n,s.N(t),e);return d=d.then(function(e){return a(f,"> set("+n+") =",void 0===e?"undefined":_typeof(e),":",s.json(e)),e})},do_get_item:function(t,n){if(!t)return Promise.reject(new Error(f+"PKEY is required!"));if(!n)return Promise.reject(new Error(f+"id is required!"));if(Array.isArray(t)){var i=m().pipeline();return t.forEach(function(e,r){var t=_(e,n);i=i.get(t)}),i.exec().then(function(e){return c(f,"> get("+t+"/"+n+") =",e),(e||[]).map(function(e){var r=_slicedToArray(e,2),t=r[0],n=r[1];return n=n&&"string"==typeof n&&n.startsWith("{")&&n.endsWith("}")?JSON.parse(n):n,t?{error:t.message||""+t}:n})})}var o=_(t,n);return m().get(o).then(function(e){if(a(f,"> get("+o+") =",void 0===e?"undefined":_typeof(e),": len=",e?s.json(e).length:"N/A"),null===e)return Promise.reject(new Error("404 NOT FOUND - "+t+"/"+n));if("object"==(void 0===(e=e&&"string"==typeof e&&e.startsWith("{")&&e.endsWith("}")?JSON.parse(e):e)?"undefined":_typeof(e)))a(f,">> item.id=",e.id||""," type=",e.type||""," name=",e.name||"",[e.created_at||0,e.updated_at||0,e.deleted_at||0]);else{var r=""+(e||"");a(f,">> item =",r.substring(0,20),20<r.length?"...":"")}return e})},do_delete_item:function(r,n){if(!r)return Promise.reject(new Error(f+"PKEY is required!"));if(!n)return Promise.reject(new Error(f+"id is required!"));if(a(f,"- do_delete_item()...",", PKEY=",r,", id=",n),Array.isArray(r)){var i=m().pipeline();return r.forEach(function(e,r){var t=_(e,n);i=i.del(t)}),i.exec().then(function(e){return c(f,"> del("+r+"/"+n+") =",e),(e||[]).map(function(e){var r=_slicedToArray(e,2),t=r[0],n=r[1];return n=n&&"string"==typeof n&&n.startsWith("{")&&n.endsWith("}")?JSON.parse(n):n,t?{error:t.message||""+t}:n})})}var t=_(r,n);return m().del(t,null).then(function(e){return a(f,"> del("+t+") =",void 0===e?"undefined":_typeof(e),":",s.json(e)),e})},do_update_item:function(e,r,t){if(!e)return Promise.reject(new Error(f+"PKEY is required!"));if(!r)return Promise.reject(new Error(f+"id is required!"));if(!t)return Promise.reject(new Error(f+"item is required!"));if(a(f,"do_update_item()...",", PKEY=",e,", id=",r,", item=",void 0===t?"undefined":_typeof(t),":",s.json(t)),t)return Promise.reject(new Error(f+"Not Supportable Yet!"));var n=_(e,r);return t=t&&"object"===(void 0===t?"undefined":_typeof(t))?JSON.stringify(t):t,c(f,"> put("+n+") =",void 0===t?"undefined":_typeof(t),":",t),m().set(n,t).then(function(e){return a(f,"> put("+n+") =",void 0===e?"undefined":_typeof(e),":",s.json(e)),e})},do_test_self:function(e){return a(f,"do_test_self()... param=",e=e||{}),s.promise(e).then(function(){var e="mykey";return a(f,"#get(mykey)..."),m().get(e).then(function(e){return a(f,"> mykey=",e),e})})}});e(r,i);s.env("EC_REGION",new Error(f+":EC_REGION is required!"));var o=s.env("EC_ENDPOINT",new Error(f+":EC_ENDPOINT is required!")),u=require("ioredis"),d=(o||"localhost:6379").split(":",2),y=_slicedToArray(d,2),l=y[0],p=new u(y[1]||6379,l||"localhost"),m=function(){if(!p)throw new Error("client is required!");return p},_=function(e,r){return e+"::"+r};return i};