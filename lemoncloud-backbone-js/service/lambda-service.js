"use strict";var _slicedToArray=function(r,e){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return function(r,e){var n=[],t=!0,o=!1,i=void 0;try{for(var a,u=r[Symbol.iterator]();!(t=(a=u.next()).done)&&(n.push(a.value),!e||n.length!==e);t=!0);}catch(r){o=!0,i=r}finally{try{!t&&u.return&&u.return()}finally{if(o)throw i}}return n}(r,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")};module.exports=function(r,e){e=e||"LS";var d=r.U,f=r.aws,n=r._;if(!d)throw new Error("$U is required!");if(!f)throw new Error("$aws is required!");if(!n)throw new Error("$_ is required!");if(!require("url"))throw new Error("URL is required!");if(!require("query-string"))throw new Error("query-string is required!");var c=r.log,m=(r.inf,r.err),w=d.NS(e,"magenta"),t={do_get:function(r,e,n,t,o,i){return a("GET",r,e,n,t,o,i)},do_post:function(r,e,n,t,o,i){return a("POST",r,e,n,t,o,i)},do_put:function(r,e,n,t,o,i){return a("PUT",r,e,n,t,o,i)},do_delete:function(r,e,n,t,o,i){return a("DELETE",r,e,n,t,o,i)}};r(e,t);var l={region:d.env("LD_REGION","ap-northeast-2")};d.env("LD_ENDPOINT")&&(l.endpoint=d.env("LD_ENDPOINT")),c(w,"!config=",l);var y=function(r){var e=d.env("LD_CONFIG",new Error("env:LD_CONFIG is required!"));if(e instanceof Error)throw e;var a=function(r){return r&&r.trim()||""},n=e.split(",").map(a).reduce(function(r,e){var n=e.split("=",2).map(a),t=_slicedToArray(n,2),o=t[0],i=t[1];return r[o]=i,r},{})[r];if(!n){if(r.startsWith("lemon-")&&0<r.indexOf("-api-prod-"))return r;throw new Error("Unknown Lambda Func-Name:"+r+", See env.LD_CONFIG!")}return n};function a(r,o,e,n,t,i,a){if(!r)return Promise.reject(new Error("method is required!"));if(!o)return Promise.reject(new Error("fname is required!"));c(w,"do_call_lambda("+r+"/"+o+").... ");var u={httpMethod:r.toUpperCase(),pathParameters:{id:e,cmd:n},queryStringParameters:t||"",body:i||""},s=y(o);return c(w,"> function-name =",s,s!=o?" <- "+o:""),c(w,"> param["+s+"] =",u),function(r,e,n){if(!r)return Promise.reject(new Error("fnName is required!"));var o={FunctionName:r,Payload:e?d.json(e):""},i=new f.Lambda(l);return new Promise(function(n,t){i.invoke(o,function(r,e){r?(m(w,"!ERR lambda =",r),t(r)):n(e)})})}(s,u).then(function(r){var e=(r=r||{}).Payload?JSON.parse(r.Payload):{},n=e.statusCode||200;c(w,"> Lambda["+o+"].StatusCode =",n);var t=function(){try{return e.body&&"string"==typeof e.body?JSON.parse(e.body):e.body}catch(r){return e.body}}();return 400==n||404==n?Promise.reject(new Error(t||"404 NOT FOUND")):200!==n?"string"==typeof t&&0<=t.indexOf("404 NOT FOUND")?Promise.reject(new Error(t||"404 NOT FOUND")):Promise.reject(new Error(t||"Lambda Error. status:"+n)):t})}return t};