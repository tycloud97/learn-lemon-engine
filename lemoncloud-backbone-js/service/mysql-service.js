"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};module.exports=function(e,r){r=r||"MS";var q=e.U,t=e.R;if(!q)throw new Error("$U is required!");if(!t)throw new Error("$R is required!");var I=q.NS(r,"blue"),$=e.log,n=(e.inf,e.err,{});function J(e,r){return q.escape(e,r)}n.do_get_last_id=function(e){return e?e.startsWith("#")?Promise.resolve(0):M("select last_insert_id(id) as id from "+e+"_seq order by id desc limit 1").then(function(e){return $(I,"> get-last-id res =",q.json(e)),(e&&e[0]||{}).id||0}):Promise.reject(new Error(I+"parameter:type is required"))},n.do_get_next_id=function(e){return e?e.startsWith("#")?Promise.resolve(0):M("insert into "+e+"_seq (id) values (0)").then(function(e){return $(I,"> get-next-id res =",q.json(e)),e&&e.insertId||0}):Promise.reject(new Error(I+"parameter:type is required"))},n.do_create_id_seq=function(e,r){if(!e)return Promise.reject(new Error(I+"parameter:type is required"));if(e.startsWith("#"))return Promise.resolve(!1);var t="create table "+e+"_seq (id int unsigned not null auto_increment primary key) auto_increment = "+(r=r||1e6)+" ";return $(I+"> query=",t),M(t).then(function(e){return 0<(e&&e.serverStatus||0)})},n.do_delete_id_seq=function(e){if(!e)return Promise.reject(new Error(I+"parameter:type is required"));if(e.startsWith("#"))return Promise.resolve(!1);var r="drop table "+e+"_seq";return $(I+"> query=",r),M(r).then(function(e){return $(I+">> result=",e),0<(e&&e.serverStatus||0)})},n.do_promise_query=function(e,r){return e?r&&!Array.isArray(r)?Promise.reject(new Error(I+"parameter:values should be array!")):M(e,r):Promise.reject(new Error(I+"parameter:query is required"))},n.do_save_node=i,n.do_save_node_hist=function(c,_,h){var m=!!T,y=JSON.stringify;m&&$(I+"do_save_node_hist_async("+c+"). node=",y(_));var e=i(c,_);return e=e.then(function(e){m&&$(I+"> save-node-hist",e);var r=e.updated_node||{},t="id",n="";if(0<c.indexOf(":")){var i=c.split(":");if(c=i[0],0<(n=i[1]).indexOf(",")){var o=n.split(",");t=o[0],n=o[1]}}var s=_[t]||_[t.toLowerCase()],a=n?_[n]||_[n.toLowerCase()]:null,u="[hist:"+c+".id:"+s+(n?","+n+":"+a:"")+"]",d=h||[],f=0;if(f+=e.inserted||0,r)for(var p in r)r[p],0<=d.indexOf(p)&&f++;(f||m)&&$(I+"> update_hist"+u+".hist_updated_count = "+f,y(r));var v={inserted:0,updated:0};if(f){t&&d.indexOf(t)<0&&d.push(t),n&&d.indexOf(n)<0&&d.push(n);var l="INSERT INTO "+c+"_hist ("+d.join(",")+") (SELECT "+d.join(",")+" FROM "+c+" WHERE "+t+" = "+J(s)+(a?" and "+n+" = "+J(a):"")+")";return m&&$(I+">> update"+u+".query=",l),l?M(l).then(function(e){return m&&$(I+">>> update"+u+".query.rs=",y(e)),v.inserted=e&&e.affectedRows||0,v}):v}return v})},n.do_read_node=function(e,t){if(!e)return Promise.reject(new Error(I+"parameter:table_name is required"));if(!t)return Promise.reject(new Error(I+"parameter:node is required"));if(void 0===t.id)return Promise.reject(new Error(I+"parameter:id is required"));var n=T,i=JSON.stringify;n&&$(I+"do_read_node_async("+e+"): ",i(t));var r="id",o="",s="";if(0<e.indexOf(":")){var a=e.split(":");if(e=a[0],0<(o=a[1]).indexOf(",")){var u=o.split(",");r=u[0]||"",o=u[1]||"",s=u[2]||""}}var d=t[r]||t[r.toLowerCase()],f=o?t[o]||t[o.toLowerCase()]:null,p=s?t[s]||t[s.toLowerCase()]:null,v="["+e+".id:"+d+(o?","+o+":"+f:"")+(s?","+s+":"+p:"")+"]",l=[],c=[];for(var _ in t){var h=_.toLowerCase(),m=!1;_||(m=!0),r!==_&&r!==h||(m=!0),void 0===t[_]&&(m=!0),h.startsWith("_")&&(m=!0),h.startsWith("$")&&(m=!0);var y=t[_];m||(l.push(_),c.push(y))}var w="select "+(l.length?r+", "+l.join(","):"*")+" from "+e+" where "+r+" = "+J(d)+(o?" and "+o+" = "+J(f):"")+(s?" and "+s+" = "+J(p):"")+" limit 1";return n&&$(I+">> read"+v+".query=",w),M(w).then(function(e){n&&$(I+">>> update.query.rs=",i(e));var r=e[0]||{};return t=q.extend(t,r),r})},n.do_test_self=function(e){return e},e(r,n);var T=!!q.is_dev;function M(e,r){return void 0===r?t.promise_query(e):t.promise_query(e,r)}function i(q,j,E){if(!q)return Promise.reject(new Error(I+"parameter:table_name is required"));if(!j)return Promise.reject(I+"parameter:node is required");var P=T,b=JSON.stringify;P&&$(I+"do_save_node_async("+q+"): ",b(j));var g="id",O="",S="";if(0<q.indexOf(":")){var e=q.split(":");if(q=e[0],0<(O=e[1]).indexOf(",")){var r=O.split(",");g=r[0]||"",O=r[1]||"",S=r[2]||""}}var x=j[g]||j[g.toLowerCase()],C=O?j[O]||j[O.toLowerCase()]:null,L=S?j[S]||j[S.toLowerCase()]:null,W="["+q+".id:"+x+(O?","+O+":"+C:"")+(S?","+S+":"+L:"")+"]",R=[],N=[];for(var t in j){var n=t.toLowerCase(),i=!1;t||(i=!0),g!==t&&g!==n||(i=!0),void 0===j[t]&&(i=!0),n.startsWith("_")&&(i=!0),n.startsWith("$")&&(i=!0);var o=j[t];i||(R.push(t),N.push(o))}if(R.length<1)throw new Error(I+"WARN! node"+W+" nothing to update");var s="select "+g+", "+R.join(",")+" from "+q+" where "+g+" = "+J(x)+(O?" and "+O+" = "+J(C):"")+(S?" and "+S+" = "+J(L):"")+" limit 1";"0"!==x&&0!==x||(s="-- WARN! dummy sql for no rows \nselect * from "+q+" where 1<>1 limit 1");var A={inserted:0,updated:0};return P&&$(I+"> select.query=",s),s?M(s).then(function(e){var r=e instanceof Error;P&&$(I+">> select.rows["+(void 0===e?"undefined":_typeof(e))+", Error:"+r+"]=",b(e));var t="",n=!e||e.length<1,i=void 0,o={};if(R.push("created_at"),N.push("now()"),R.push("updated_at"),N.push("now()"),n){if(P&&$(I+">> WARN! node"+W+" not found"),E)for(var s in E){var a=E[s];R.push(s),N.push(a)}i=[];var u=[];for(var d in N){var f=N[d];"now()"===f?u.push(f):(u.push("?"),i.push(f))}t="insert into "+q+" ("+g+","+R.join(",")+") values ("+J(x)+","+u.join(",")+")"}else{var p=e[0];P&&$(I+">> select.found=",b(p));var v=0;for(var l in p){var c=l.toLowerCase();if(c!==g&&("created_at"!==c&&"updated_at"!==c)){var _=p[l],h=void 0!==j[c]?j[c]:_;_!==h&&(v++,o[c]=h)}}if(P&&$(I+">> update_count"+W+"="+(v||0)+", update_set=",o),0<v){var m=[];for(var y in i=[],o){var w=o[y];m.push(y+"=?"),i.push(w)}m.push("updated_at = now()"),t="update "+q+" set "+m.join(", ")+" where "+g+" = "+J(x)+" "+(O?" and "+O+" = "+J(C):"")+(S?" and "+S+" = "+J(L):"")}else t="";o[g]=x,O&&(o[O]=C),S&&(o[S]=L)}return P&&$(I+">> update.query="+t+", values=",b(i)),t?M(t,i).then(function(e){return P&&$(I+">>> update.query.rs=",b(e)),n?(A.insertId=e&&e.insertId||0,A.inserted=e&&e.affectedRows||0):(A.updated=e&&e.changedRows||0,A.updated_node=o),A}):A}):A}return n};