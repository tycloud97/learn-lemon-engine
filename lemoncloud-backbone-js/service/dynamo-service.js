"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};module.exports=function(e,r){r=r||"DS";var u=e.U,t=e.aws,s=e._;if(!u)throw new Error("$U is required!");if(!t)throw new Error("$aws is required!");if(!s)throw new Error("$_ is required!");var d=u.NS(r,"magenta"),m=e.log,c=(e.inf,e.err),n={do_create_table:function(e,r,t){if(!e)return Promise.reject(new Error(d+"parameter:table is required"));var n={TableName:e,KeySchema:[{AttributeName:r=r||"id",KeyType:"HASH"}],AttributeDefinitions:[{AttributeName:r,AttributeType:(t=t||"Number").substring(0,1)}],ProvisionedThroughput:{ReadCapacityUnits:1,WriteCapacityUnits:1},StreamSpecification:{StreamEnabled:!0,StreamViewType:"NEW_AND_OLD_IMAGES"}};return m(d,"do_create_table("+e+").... payload=",n),a.createTable(n).promise().then(function(e){return m(d,"> res=",e),e}).catch(function(e){throw c(d,"> err="+e.code+" - "+e.message),e})},do_delete_table:function(e){if(!e)return Promise.reject(new Error(d+"parameter:table is required"));var r={TableName:e};return m(d,"- do_delete_table().... payload=",r),a.deleteTable(r).promise().then(function(e){return m(d,"> dynamodb.deleteTable.res=",u.json(e)),e}).catch(function(e){var r=e&&e.message||"";if(0<r.indexOf("not found:"))return Promise.reject(new Error("404 NOT FOUND - "+r));throw e})}};n.do_list_tables=l,n.do_create_item=function(e,r,t){if(!e)return Promise.reject(new Error(d+"parameter:table is required"));if(!r)return Promise.reject(new Error(d+"parameter:id is required"));if(!t)return Promise.reject(new Error(d+"parameter:data is required"));if("object"!==(void 0===t?"undefined":_typeof(t)))return Promise.reject(new Error(d+"parameter:data must be object"));var n="object"===(void 0===r?"undefined":_typeof(r))?r:{id:u.N(r)};n.idType;delete n.idType,t=u.extend(t,n),t=o(t);var i={TableName:e,Item:t};return m(d,"- do_create_item("+e+").... ,id=",n,", data=",u.json(t)),f.put(i).promise().then(function(e){return m(d,"> res=",u.json(e)),e=u.extend(n,e)}).catch(function(e){throw e})},n.do_get_item=function(e,r){if(!e)return Promise.reject(new Error(d+"parameter:table is required"));if(!r)return Promise.reject(new Error(d+"parameter:id is required"));var t="object"===(void 0===r?"undefined":_typeof(r))?r:{id:u.N(r)};t.idType;delete t.idType;var n={TableName:e,Key:t};return m(d,"- do_get_item("+e+").... id=",t),f.get(n).promise().then(function(e){return m(d,"> res=",e&&u.json(e)||e),void 0===e.Item?Promise.reject(new Error("404 NOT FOUND")):e.Item||{}}).catch(function(e){throw e})},n.do_delete_item=function(e,r){if(!e)return Promise.reject(new Error(d+"parameter:table is required"));if(!r)return Promise.reject(new Error(d+"parameter:id is required"));var t="object"===(void 0===r?"undefined":_typeof(r))?r:{id:u.N(r)};t.idType;delete t.idType;var n={TableName:e,Key:t};return m(d,"- do_delete_item("+e+")...., id=",t),f.delete(n).promise().then(function(e){return m(d,"> res=",u.json(e)),e=u.extend(t,e)}).catch(function(e){throw e})},n.do_update_item=h,n.do_increment_item=function(e,r,t,n){if(!e)return Promise.reject(new Error(d+"parameter:table is required"));if(!r)return Promise.reject(new Error(d+"parameter:id is required"));if(!t)return Promise.reject(new Error(d+"parameter:data is required"));if("object"!==(void 0===t?"undefined":_typeof(t)))return Promise.reject(new Error(d+"parameter:data must be object"));var i="object"===(void 0===r?"undefined":_typeof(r))?r:{id:u.N(r)};i.idType;delete i.idType,m(d,"- do_increment_item("+e+")...., id=",i,", data=",u.json(t));var a=["created_at","updated_at","deleted_at"],o=s.reduce(t,function(e,r,t){return 0<=a.indexOf(t)?(e.ExpressionAttributeNames["#"+t]=t,e.ExpressionAttributeValues[":"+t]=r,e.UpdateExpression.push("#"+t+" = :"+t),m(d,">> #"+t+" = :"+r)):(e.ExpressionAttributeNames["#"+t]=t,e.ExpressionAttributeValues[":"+t]=r,e.UpdateExpression.push("#"+t+" = #"+t+" + :"+t),m(d,">> #"+t+" = #"+t+" + :"+r)),e},{TableName:e,Key:i,UpdateExpression:[],ExpressionAttributeNames:{},ExpressionAttributeValues:{}});return b(o,n),o.UpdateExpression="SET "+o.UpdateExpression.join(", "),m(d,"> payload=",u.json(o)),f.update(o).promise().then(function(e){return m(d,"> res=",u.json(e)),e=u.extend(i,e)}).catch(function(e){throw e})},n.do_test_self=function(e){m(d,"- do_test_self()... param=",e=e||{});var r=u.promise(e);return r=(r=r.then(function(){return l().then(function(e){return m(d,"> ListTables=",e),e})})).then(function(e){return e})},n.do_read_stream=function(e){e=e||{},m(d,"- do_read_stream()... param=",u.json(e)),e.table=e.table||"TestTable";var r=u.promise(e);return r=(r=e.streams?r:r.then(function(r){var e={Limit:100,TableName:r.table||"TestTable"};return m(d,"- listStreams()...."),p.listStreams(e).promise().then(function(e){return m(d,"> list-streams res =",u.json(e)),r.streams=s.map(e.Streams,function(e,r){m(d,">> ["+r+"] stream=",u.json(e));var t={};return t.TableName=e.TableName,t.ExclusiveStartShardId=null,t.SequenceNumber=null,t.StreamArn=e.StreamArn,t}),r}).then(function(e){return e})})).then(function(i){if(!i.streams)return Promise.reject(new Error(d+"streams is required"));m(d,"- describe-streams() ... ");var e=s.map(i.streams,function(r,e){m(d,"> streams["+e+"] =",u.json(r));var t={StreamArn:r.StreamArn};return r.ExclusiveStartShardId&&(t.ExclusiveStartShardId=r.ExclusiveStartShardId),m(d,"-- describe-stream()... params=",u.json(t)),p.describeStream(t).promise().then(function(e){return r.shards=e.StreamDescription.Shards||[],r.shards.forEach(function(e,r){m(d,">> shards["+r+"] SequenceNumberRange=",e.SequenceNumberRange.StartingSequenceNumber,"~",e.SequenceNumberRange.EndingSequenceNumber)}),r}).then(function(t){if(!t.shards)return Promise.reject(new Error(d+"shards is required"));var a=function(e,t){var r=u.promise(e.shift());return r=e.reduce(function(e,r){return e.then(function(){return t(r)})},r.then(function(e){return t(e)}))},o=function(e){return e?(t.SequenceNumber=e.dynamodb.SequenceNumber,m(d,"!! stream.SequenceNumber=",t.SequenceNumber),i.on_process_record?(e.eventSourceARN=t.StreamArn,i.on_process_record(e)):e):Promise.resolve(e)},n=function n(i){if(!i)return Promise.resolve(i);var e={ShardIterator:i,Limit:1e3};return m(d,"----- get-records()... params=",u.json(e)),p.getRecords(e).promise().then(function(e){var r=e.Records||[],t=e.NextShardIterator;return m(d,">>>>> records.len=",r.length,", next-iterator=",t),r.length?a(r,o).then(function(e){return t?n(t):(m(d,"! finished iterator!"),e)}).then(function(){return i}):e})};return a(t.shards,function(e){return e?(m(d,"--- process-shard=",u.json(e)),Promise.resolve(e).then(function(r){if(r.SequenceNumberRange.EndingSequenceNumber)return m(d,">>> closed shard!!!!!"),t.ExclusiveStartShardId=r.ShardId,t.SequenceNumber=null,r;t.SequenceNumber&&t.SequenceNumber<r.SequenceNumberRange.StartingSequenceNumber&&(t.SequenceNumber=null);var e={ShardId:r.ShardId,StreamArn:t.StreamArn};return t.SequenceNumber?(e.SequenceNumber=t.SequenceNumber,e.ShardIteratorType="AFTER_SEQUENCE_NUMBER"):e.ShardIteratorType="TRIM_HORIZON",m(d,"---- get-shard-iterator()... params=",u.json(e)),p.getShardIterator(e).promise().then(function(e){var r=e.ShardIterator;return n(r)}).then(function(){return r}).catch(function(e){return c(d,">>>> get-shard-iterator err=",e),r})}).then(function(){return e})):Promise.resolve(e)})})});return Promise.all(e).then(function(e){return i})}).then(function(e){return e})},e(r,n);var i={region:u.env("DD_REGION",new Error(d+":DD_REGION is required!"))};u.env("DD_ENDPOINT")&&(i.endpoint=u.env("DD_ENDPOINT"));var a=new t.DynamoDB(i),f=new t.DynamoDB.DocumentClient(i),p=new t.DynamoDBStreams(i),o=function n(i){return""===i?null:i?Array.isArray(i)?i.map(n):"object"==(void 0===i?"undefined":_typeof(i))?Object.keys(i).reduce(function(e,r){var t=i[r];return e[r]=n(t),e},{}):i:i};function l(e,r){var n=e,t={Limit:r=r||100};return m(d,"- do_list_table().... payload=",t),a.listTables(t).promise().then(function(t){m(d,"> res=",u.json(t));var e=t.TableNames;if(n&&0<=e.indexOf(n)){var r={Limit:100,TableName:n};return m(d,"- listStreams()...."),p.listStreams(r).promise().then(function(e){var r=s.map(e.Streams,function(e,r){m(d,">> ["+r+"] stream=",u.json(e));var t={};return t.TableName=e.TableName,t.ExclusiveStartShardId=null,t.SequenceNumber=null,t.StreamArn=e.StreamArn,t});return t[n]={streams:r},t})}return t}).then(function(e){return m(d,"! list-tables res=",u.json(e)),e}).catch(function(e){throw c(d,"> err=",e),e})}var b=function(e,r){return r?e=s.reduce(r,function(e,r,t){return e.ExpressionAttributeNames["#"+t]=t,e.ExpressionAttributeValues[":"+t]=r,e.UpdateExpression.push("#"+t+" = #"+t+" + :"+t),m(d,">> #"+t+" = #"+t+" + :"+r),e},e):e};function h(e,r,t,n){if(!e)return Promise.reject(new Error(d+"parameter:table is required"));if(!r)return Promise.reject(new Error(d+"parameter:id is required"));if(!t)return Promise.reject(new Error(d+"parameter:data is required"));if("object"!==(void 0===t?"undefined":_typeof(t)))return Promise.reject(new Error(d+"parameter:data must be object"));var i="object"===(void 0===r?"undefined":_typeof(r))?r:{id:u.N(r)};i.idType;delete i.idType,m(d,"- do_update_item("+e+")...., id=",i,", data=",u.json(t));var a=s.reduce(t,function(e,r,t){return r=o(r),e.ExpressionAttributeNames["#"+t]=t,e.ExpressionAttributeValues[":"+t]=""===r?null:r,e.UpdateExpression.push("#"+t+" = :"+t),m(d,">> #"+t+" :=",void 0===r?"undefined":_typeof(r),u.json(r)),e},{TableName:e,Key:i,UpdateExpression:[],ExpressionAttributeNames:{},ExpressionAttributeValues:{}});return b(a,n),a.UpdateExpression="SET "+a.UpdateExpression.join(", "),m(d,"> payload=",u.json(a)),f.update(a).promise().then(function(e){return m(d,"> res=",u.json(e)),e=u.extend(i,e)}).catch(function(e){throw e})}return n};