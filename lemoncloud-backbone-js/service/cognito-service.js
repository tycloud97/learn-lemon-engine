"use strict";var _slicedToArray=function(r,e){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return function(r,e){var t=[],i=!0,o=!1,n=void 0;try{for(var s,u=r[Symbol.iterator]();!(i=(s=u.next()).done)&&(t.push(s.value),!e||t.length!==e);i=!0);}catch(r){o=!0,n=r}finally{try{!i&&u.return&&u.return()}finally{if(o)throw n}}return t}(r,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")};module.exports=function(r,e){e=e||"CS";var n=r.U,t=r.aws,i=r._;if(!n)throw new Error("$U is required!");if(!t)throw new Error("$aws is required!");if(!i)throw new Error("$_ is required!");var s=r.log,u=(r.inf,r.err),a=n.NS(e,"magenta"),o={do_get_user:function(t,i){if(!t)return Promise.reject(new Error("userPoolId is required!"));if(!i)return Promise.reject(new Error("userSub is required!"));var r={UserPoolId:t=m(t),Filter:'sub = "'+i+'"',Limit:1};i&&/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(i)?r.Filter='email = "'+i+'"':n.N(i,0)==i&&(r.Filter="given_name = "+i);return s(a,"> user.filter=",r),d.listUsers(r).promise().then(function(r){s(a,"> "+t+".res=",r);var e=r&&r.Users||[];return!e||e.length<1?Promise.reject(new Error("404 NOT FOUND - sub:"+i)):e[0]}).then(f).catch(function(r){throw u(a,"ERR! getUser:",r),r})},do_get_enable_user:function(e,t){if(!e)return Promise.reject(new Error("userPoolId is required!"));if(!t)return Promise.reject(new Error("userSub is required!"));var r={UserPoolId:e=m(e),Username:t};return d.adminEnableUser(r).promise().then(function(r){return s(a,"> "+e+".res=",r),r}).catch(function(r){var e=r&&r.message||"";if(e.startsWith("User does not exist"))return Promise.reject(new Error("404 NOT FOUND - UserName:"+t));throw u(a,"ERR! adminEnableUser:",r),r})},do_get_disable_user:function(e,t){if(!e)return Promise.reject(new Error("userPoolId is required!"));if(!t)return Promise.reject(new Error("userSub is required!"));var r={UserPoolId:e=m(e),Username:t};return d.adminDisableUser(r).promise().then(function(r){return s(a,"> "+e+".res=",r),r}).catch(function(r){var e=r&&r.message||"";if(e.startsWith("User does not exist"))return Promise.reject(new Error("404 NOT FOUND - UserName:"+t));throw u(a,"ERR! adminDisableUser:",r),r})},do_get_confirm_user:function(e,t){if(!e)return Promise.reject(new Error("userPoolId is required!"));if(!t)return Promise.reject(new Error("userSub is required!"));var r={UserPoolId:e=m(e),Username:t};return d.adminConfirmSignUp(r).promise().then(function(r){return s(a,"> "+e+".res=",r),r}).catch(function(r){var e=r&&r.message||"";if(e.startsWith("User does not exist"))return Promise.reject(new Error("404 NOT FOUND - UserName:"+t));throw u(a,"ERR! adminConfirmSignUp:",r),r})},do_list_user:function(i,r,e,o){if(!i)return Promise.reject(new Error("userPoolId is required!"));i=m(i),o=n.N(o,1);var t={UserPoolId:i,Filter:"",Limit:o};r&&(t.Filter=r+'="'+e+'"');return d.listUsers(t).promise().then(function(r){s(a,"> "+i+".res=",r);var e=r&&r.Users||[],t=e.map(f);return{limit:o,list:t}}).catch(function(r){throw u(a,"ERR! listUsers:",r),r})},do_update_user:function(r,t,o){if(!r)return Promise.reject(new Error("userPoolId is required!"));if(!t)return Promise.reject(new Error("userSub is required!"));if(!o)return Promise.reject(new Error("$attr is required!"));var e={UserPoolId:r=m(r),Username:t};if(e.UserAttributes=Object.keys(o).reduce(function(r,e){var t=o[e];if(e.startsWith("custom:"));else{if(void 0===t)return r;if("email"==e||"username"==e)return r}var i={Name:e,Value:t};return r.push(i),r},[]),e.UserAttributes.length<1)return Promise.reject(new Error("valid UserAttributes required!"));return d.adminUpdateUserAttributes(e).promise().then(function(r){return s(a,"> update("+t+").res=",r),r}).catch(function(r){var e=r&&r.message||"";if(e.startsWith("User does not exist"))return Promise.reject(new Error("404 NOT FOUND - UserName:"+t));throw u(a,"ERR! adminUpdateUserAttributes:",r),r})},do_list_group:function(i,o){if(!i)return Promise.reject(new Error("userPoolId is required!"));i=m(i),o=n.N(o,1);var r={UserPoolId:i,Limit:o};return d.listGroups(r).promise().then(function(r){s(a,"> list-group("+i+").res=",r);var e=r&&r.Groups||[],t=e.map(f);return{limit:o,list:t}}).catch(function(r){throw u(a,"ERR! listGroups:",r),r})},do_get_group:function(e,t){if(!e)return Promise.reject(new Error("userPoolId is required!"));if(!t)return Promise.reject(new Error("groupId is required!"));var r={UserPoolId:e=m(e),GroupName:t};return d.getGroup(r).promise().then(function(r){return s(a,"> getGroup("+e+").res=",r),r}).then(f).catch(function(r){var e=r&&r.message||"";if(e.startsWith("Group not found"))return Promise.reject(new Error("404 NOT FOUND - GroupName:"+t));throw u(a,"ERR! getGroup:",r),r})},do_create_group:function(e,r,t){if(!e)return Promise.reject(new Error("userPoolId is required!"));if(!r)return Promise.reject(new Error("groupName is required!"));var i={UserPoolId:e=m(e),GroupName:r};t&&(i.Description=t);return d.createGroup(i).promise().then(function(r){return s(a,"> createGroup("+e+").res=",r),r}).catch(function(r){var e=r&&r.message||"";if(e.startsWith("Group not found"))return Promise.reject(new Error("404 NOT FOUND - GroupName:"+groupId));throw u(a,"ERR! getGroup:",r),r})},do_add_user_to_group:function(e,t,i){if(!e)return Promise.reject(new Error("userPoolId is required!"));if(!t)return Promise.reject(new Error("groupId is required!"));if(!i)return Promise.reject(new Error("userId is required!"));var r={UserPoolId:e=m(e),GroupName:t,Username:i};return d.adminAddUserToGroup(r).promise().then(function(r){return s(a,"> adminAddUserToGroup("+e+").res=",r),r}).then(f).catch(function(r){var e=r&&r.message||"";if(e.startsWith("Group not found"))return Promise.reject(new Error("404 NOT FOUND - GroupName:"+t));if(e.startsWith("User does not exist"))return Promise.reject(new Error("404 NOT FOUND - UserName:"+i));throw u(a,"ERR! getGroup:",r),r})}};r(e,o);var c={region:n.env("CC_REGION",new Error(a+":CC_REGION is required!"))};s(a,"config=",c);var d=new t.CognitoIdentityServiceProvider(c),m=function(r){var e=n.env("CC_POOLSET",new Error(a+":CC_POOLSET is required!"));if(e instanceof Error)throw e;var t=e.split(",").map(function(r){return r.trim()}).reduce(function(r,e){var t=e.split("=",2),i=_slicedToArray(t,2),o=i[0],n=i[1];return r[o]=n,r},{});if(s(a,"> CC_POOLSET=",t),null==t[r])throw new Error(a+": unknown user-pool name:"+r);return t[r]};function f(r){var e=r.Attributes||[];return delete r.Attributes,e.reduce(function(r,e){var t=e.Name||"",i=e.Value||"";return t&&(r[t]=i),r},r),r}return o};