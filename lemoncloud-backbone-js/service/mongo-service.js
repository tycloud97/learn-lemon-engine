"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};module.exports=function(e,r){r=r||"GS";var a=e.U,t=e.aws,s=e._;if(!a)throw new Error("$U is required!");if(!t)throw new Error("$aws is required!");if(!s)throw new Error("$_ is required!");var f=a.NS(r,"magenta"),l=e.log,i=(e.inf,e.err),n={do_create_table:function(r,e,t){if(!r)return Promise.reject(new Error(f+"parameter:table is required"));e=e||"id",t=t||"Number";return l(f,"do_create_table("+r+").... payload=",{}),m().then(function(e){return e.db().createCollection(r).catch(function(e){return e&&(e.message||e.type),i(f,"> create-table.err =",e),"ignore"}).then(function(e){return l(f,"> create-table.res = ",e),{TableDescription:{TableName:r}}})})},do_delete_table:function(r){return r?(l(f,"- do_delete_table().... payload=",{TableName:r}),m().then(function(e){return e.db().dropCollection(r)}).then(function(e){return l(f,"> delete-table.res = ",e),{TableDescription:{TableName:r}}})):Promise.reject(new Error(f+"parameter:table is required"))}};n.do_list_tables=d,n.do_create_item=function(e,r,t){if(!e)return Promise.reject(new Error(f+"parameter:table is required"));if(!r)return Promise.reject(new Error(f+"parameter:id is required"));if(!t)return Promise.reject(new Error(f+"parameter:data is required"));if("object"!==(void 0===t?"undefined":_typeof(t)))return Promise.reject(new Error(f+"parameter:data must be object"));var n="object"===(void 0===r?"undefined":_typeof(r))?r:{id:a.N(r)};n.idType;delete n.idType,t=a.extend(t,n),t=c(t);Object.keys(n).pop();return l(f,"- do_create_item("+e+").... ,id=",n,", data=",a.json(t)),m().then(function(r){return r.db().collection(e).insertOne(t).then(function(e){return e.result}).then(function(e){return r.close(),e})}).catch(function(e){var r=e&&e.message||e;return i(f,"> create-item.err = ",r),Promise.reject(new Error(r))})},n.do_get_item=function(e,r){if(!e)return Promise.reject(new Error(f+"parameter:table is required"));if(!r)return Promise.reject(new Error(f+"parameter:id is required"));var t="object"===(void 0===r?"undefined":_typeof(r))?r:{id:a.N(r)};t.idType;delete t.idType;Object.keys(t).pop();return l(f,"- do_get_item("+e+").... id=",t),m().then(function(r){return r.db().collection(e).findOne(t).then(function(e){return l(f,"> node =",e),null===e?Promise.reject(new Error("404 NOT FOUND")):e}).then(function(e){return r.close(),e})})},n.do_delete_item=function(e,r){if(!e)return Promise.reject(new Error(f+"parameter:table is required"));if(!r)return Promise.reject(new Error(f+"parameter:id is required"));var t="object"===(void 0===r?"undefined":_typeof(r))?r:{id:a.N(r)};t.idType;delete t.idType;Object.keys(t).pop();return l(f,"- do_delete_item("+e+")...., id=",t),m().then(function(r){return r.db().collection(e).findAndRemove(t).then(function(e){return r.close(),e})})},n.do_update_item=function(e,r,t,n){if(!e)return Promise.reject(new Error(f+"parameter:table is required"));if(!r)return Promise.reject(new Error(f+"parameter:id is required"));if(!t)return Promise.reject(new Error(f+"parameter:data is required"));if("object"!==(void 0===t?"undefined":_typeof(t)))return Promise.reject(new Error(f+"parameter:data must be object"));var i="object"===(void 0===r?"undefined":_typeof(r))?r:{id:a.N(r)};i.idType;delete i.idType,l(f,"- do_update_item("+e+")...., id=",i,", data=",a.json(t));var o=s.reduce(t,function(e,r,t){return r=c(r),e[""+t]=r,e},{}),u=n&&s.reduce(n,function(e,r,t){return e[""+t]=r,e},{}),d={};o&&0<Object.keys(o).length&&(d.$set=o);u&&0<Object.keys(u).length&&(d.$inc=u);Object.keys(i).pop();return l(f,"> payload=",a.json(d)),m().then(function(r){return r.db().collection(e).updateOne(i,d).then(function(e){return e.result}).then(function(e){return r.close(),e})})},n.do_increment_item=function(e,r,t,n){if(!e)return Promise.reject(new Error(f+"parameter:table is required"));if(!r)return Promise.reject(new Error(f+"parameter:id is required"));if(!t)return Promise.reject(new Error(f+"parameter:data is required"));if("object"!==(void 0===t?"undefined":_typeof(t)))return Promise.reject(new Error(f+"parameter:data must be object"));var i="object"===(void 0===r?"undefined":_typeof(r))?r:{id:a.N(r)};i.idType;delete i.idType,l(f,"- do_increment_item("+e+")...., id=",i,", data=",a.json(t));var o=["created_at","updated_at","deleted_at"],u=n&&s.reduce(n,function(e,r,t){return e[""+t]=r,e},{})||{},d=s.reduce(t,function(e,r,t){return 0<=o.indexOf(t)?e[""+t]=r:u[""+t]=r,e},{}),c={};d&&0<Object.keys(d).length&&(c.$set=d);u&&0<Object.keys(u).length&&(c.$inc=u);Object.keys(i).pop();return l(f,"> payload=",a.json(c)),m().then(function(r){return r.db().collection(e).updateOne(i,c).then(function(e){return e.result}).then(function(e){return r.close(),e})})},n.do_test_self=function(e){l(f,"- do_test_self()... param=",e=e||{});var r=a.promise(e);return r=(r=r.then(function(){return d().then(function(e){return l(f,"> ListTables=",e),e})})).then(function(e){return e})},n.do_read_stream=function(e){return Promise.reject(new Error(f+":NOT SUPPORTED!"))},e(r,n);var o={region:a.env("MG_REGION",new Error(f+":MG_REGION is required!"))};a.env("MG_ENDPOINT")&&(o.endpoint=a.env("MG_ENDPOINT"));var u=require("mongodb").MongoClient,m=(require("assert"),function(){var e=o.endpoint;return e?u.connect(e):Promise.reject(new Error(f+":endpoint is required!"))}),c=function n(i){return""===i?null:i?Array.isArray(i)?i.map(n):"object"==(void 0===i?"undefined":_typeof(i))?Object.keys(i).reduce(function(e,r){var t=i[r];return e[r]=n(t),e},{}):i:i};function d(t,e){return l(f,"- do_list_table().... payload=",{Limit:e=e||100}),m().then(function(e){return e.db().collections().then(function(e){return t&&(e=e.reduce(function(e,r){return r.collectionName==t&&e.push(r),e},[])),{TableNames:e=e.map(function(e){return e.collectionName})}})})}return n};